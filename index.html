<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INTUITY - C1/C2 Conditionals Master</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', 'Space Grotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1d3a 100%);
      color: white;
      min-height: 100vh;
      padding: 1rem;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      padding: 1.25rem 0 1rem;
      position: relative;
    }

    .profile-badge {
      position: absolute;
      top: 0;
      right: 1rem;
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 0.5rem 1rem;
      border-radius: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border: 1px solid rgba(201, 169, 97, 0.25);
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .profile-badge:hover {
      background: rgba(28, 28, 30, 0.95);
      border-color: #C9A961;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(201, 169, 97, 0.2);
    }

    .xp-display {
      font-size: 0.75rem;
      color: #C9A961;
      font-weight: 600;
    }

    .header h1 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 2.25rem;
      font-weight: 700;
      color: #C9A961;
      margin-bottom: 0.5rem;
      letter-spacing: -0.04em;
      text-transform: uppercase;
      background: linear-gradient(135deg, #C9A961 0%, rgba(201, 169, 97, 0.8) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header .subtitle {
      font-size: 0.8125rem;
      color: #8e8e93;
      margin-bottom: 0.375rem;
      font-weight: 500;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .header .author {
      font-size: 0.6875rem;
      color: #636366;
      font-weight: 400;
      letter-spacing: 0.02em;
    }

    .cambridge-badge {
      display: inline-block;
      background: rgba(201, 169, 97, 0.15);
      padding: 0.5rem 1.5rem;
      border-radius: 2rem;
      border: 1px solid rgba(201, 169, 97, 0.3);
      font-size: 0.75rem;
      color: #C9A961;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-top: 0.5rem;
    }

    .achievement-icon {
      font-size: 1.5rem;
    }

    .mode-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .mode-card {
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      padding: 2rem;
      border-radius: 1.5rem;
      border: 1.5px solid rgba(201, 169, 97, 0.25);
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .mode-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #C9A961, rgba(201, 169, 97, 0.8));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .mode-card:hover::before {
      opacity: 1;
    }

    .mode-card:hover {
      transform: translateY(-8px) scale(1.02);
      border-color: rgba(201, 169, 97, 0.5);
      box-shadow: 0 12px 40px rgba(201, 169, 97, 0.25),
                  0 0 0 1px rgba(201, 169, 97, 0.3),
                  0 4px 16px rgba(0, 0, 0, 0.3);
      background: rgba(28, 28, 30, 0.95);
    }

    .mode-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .mode-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #C9A961;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .mode-desc {
      font-size: 0.9rem;
      color: #8e8e93;
      margin-bottom: 1rem;
      line-height: 1.5;
    }

    .mode-stats {
      display: flex;
      justify-content: space-around;
      padding-top: 1rem;
      border-top: 1px solid rgba(201, 169, 97, 0.2);
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #C9A961;
    }

    .stat-label {
      font-size: 0.75rem;
      color: #636366;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .game-settings {
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      padding: 2rem;
      border-radius: 1.5rem;
      margin-bottom: 2rem;
      border: 1.5px solid rgba(201, 169, 97, 0.25);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .setting-group {
      background: rgba(20, 25, 30, 0.7);
      padding: 1.5rem;
      border-radius: 1rem;
      border: 1px solid rgba(201, 169, 97, 0.2);
    }

    .setting-label {
      font-size: 0.85rem;
      color: #8e8e93;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 0.75rem;
    }

    .setting-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #C9A961;
    }

    .slider {
      width: 100%;
      margin-top: 0.75rem;
      -webkit-appearance: none;
      height: 8px;
      border-radius: 4px;
      background: rgba(201, 169, 97, 0.15);
      outline: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #C9A961;
      cursor: pointer;
      transition: all 0.3s;
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 12px rgba(201, 169, 97, 0.8);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.75rem;
    }

    .checkbox {
      width: 24px;
      height: 24px;
      cursor: pointer;
      accent-color: #C9A961;
    }

    .difficulty-selector {
      display: flex;
      gap: 0.75rem;
      margin-top: 0.75rem;
    }

    .difficulty-btn {
      flex: 1;
      padding: 0.5rem;
      background: rgba(20, 25, 30, 0.6);
      border: 1px solid rgba(201, 169, 97, 0.2);
      border-radius: 0.5rem;
      color: #8e8e93;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .difficulty-btn:hover {
      border-color: #C9A961;
    }

    .difficulty-btn.active {
      background: rgba(201, 169, 97, 0.15);
      border-color: #C9A961;
      color: #C9A961;
    }

    .scoreboard {
      display: flex;
      justify-content: space-between;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .player-panel {
      flex: 1;
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      padding: 2rem;
      border-radius: 1.5rem;
      border: 1.5px solid rgba(201, 169, 97, 0.25);
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .player-panel.active {
      border-color: #C9A961;
      box-shadow: 0 0 32px rgba(201, 169, 97, 0.3);
    }

    .player-panel.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #C9A961, rgba(201, 169, 97, 0.8));
      animation: glow 2s ease-in-out infinite;
    }

    @keyframes glow {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    .player-emoji {
      font-size: 4rem;
      text-align: center;
      margin-bottom: 1rem;
    }

    .player-name {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      color: #C9A961;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 1.5rem;
    }

    .player-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    .player-stat {
      text-align: center;
      padding: 1rem;
      background: rgba(20, 25, 30, 0.7);
      border-radius: 0.75rem;
    }

    .player-stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: #C9A961;
    }

    .player-stat-label {
      font-size: 0.7rem;
      color: #636366;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 0.25rem;
    }

    .powerup-display {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(201, 169, 97, 0.2);
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .powerup-item {
      background: rgba(20, 25, 30, 0.7);
      padding: 0.5rem 1rem;
      border-radius: 1rem;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border: 1px solid rgba(201, 169, 97, 0.2);
    }

    .powerup-item.active {
      background: rgba(201, 169, 97, 0.15);
      border-color: #C9A961;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .round-indicator {
      text-align: center;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: rgba(201, 169, 97, 0.08);
      border-radius: 1rem;
      border: 1px solid rgba(201, 169, 97, 0.25);
    }

    .round-text {
      font-size: 1.25rem;
      font-weight: 700;
      color: #C9A961;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .round-progress {
      margin-top: 1rem;
      height: 12px;
      background: rgba(201, 169, 97, 0.15);
      border-radius: 6px;
      overflow: hidden;
    }

    .round-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #C9A961, rgba(201, 169, 97, 0.8));
      border-radius: 6px;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .board-container {
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      padding: 2rem;
      border-radius: 1.5rem;
      border: 1.5px solid rgba(201, 169, 97, 0.25);
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .board {
      display: grid;
      gap: 1rem;
      margin: 0 auto;
      max-width: 600px;
    }

    .board.size-3 { grid-template-columns: repeat(3, 1fr); }
    .board.size-4 { grid-template-columns: repeat(4, 1fr); }
    .board.size-5 { grid-template-columns: repeat(5, 1fr); }

    .cell {
      aspect-ratio: 1;
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 2px solid rgba(201, 169, 97, 0.25);
      border-radius: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .cell::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(201, 169, 97, 0.15), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .cell:hover:not(.claimed-X):not(.claimed-O):not(.special-cell)::before {
      opacity: 1;
    }

    .cell:hover:not(.claimed-X):not(.claimed-O) {
      transform: scale(1.05);
      border-color: rgba(201, 169, 97, 0.5);
      box-shadow: 0 8px 24px rgba(201, 169, 97, 0.25);
    }

    .cell.claimed-X {
      background: rgba(255, 59, 100, 0.2);
      border-color: #ff3b64;
      cursor: not-allowed;
    }

    .cell.claimed-O {
      background: rgba(52, 199, 150, 0.2);
      border-color: #34c796;
      cursor: not-allowed;
    }

    .cell.special-cell {
      background: linear-gradient(135deg, rgba(201, 169, 97, 0.15), rgba(201, 169, 97, 0.08));
      border-color: #C9A961;
      animation: specialGlow 3s ease-in-out infinite;
    }

    .cell.special-cell::after {
      content: '⭐';
      position: absolute;
      top: 0.25rem;
      right: 0.25rem;
      font-size: 1rem;
    }

    @keyframes specialGlow {
      0%, 100% { box-shadow: 0 0 20px rgba(201, 169, 97, 0.3); }
      50% { box-shadow: 0 0 40px rgba(201, 169, 97, 0.5); }
    }

    .timer-container {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(28, 28, 30, 0.95);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      padding: 1rem 2rem;
      border-radius: 2rem;
      border: 1.5px solid rgba(201, 169, 97, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      display: none;
    }

    .timer-container.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    .timer-display {
      font-size: 2rem;
      font-weight: 700;
      color: #C9A961;
      text-align: center;
    }

    .timer-display.warning {
      color: #ff9500;
      animation: timerPulse 1s ease-in-out infinite;
    }

    .timer-display.danger {
      color: #ff3b30;
      animation: timerPulse 0.5s ease-in-out infinite;
    }

    @keyframes timerPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 0.75rem;
      font-weight: 700;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .btn-primary {
      background: linear-gradient(135deg, #C9A961 0%, rgba(201, 169, 97, 0.85) 100%);
      color: white;
      box-shadow: 0 4px 16px rgba(201, 169, 97, 0.25);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(201, 169, 97, 0.4);
    }

    .btn-primary:active {
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: rgba(28, 28, 30, 0.85);
      border: 1px solid rgba(201, 169, 97, 0.25);
      color: #e5e5e7;
    }

    .btn-secondary:hover {
      background: rgba(28, 28, 30, 0.95);
      border-color: rgba(201, 169, 97, 0.4);
      transform: translateY(-2px);
    }

    .btn-secondary:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-powerup {
      background: rgba(201, 169, 97, 0.15);
      border: 1px solid #C9A961;
      color: #C9A961;
      padding: 0.75rem 1.5rem;
      font-size: 0.9rem;
    }

    .btn-powerup:hover:not(:disabled) {
      background: rgba(201, 169, 97, 0.25);
      transform: translateY(-2px);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      z-index: 999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: rgba(28, 28, 30, 0.98);
      backdrop-filter: blur(60px) saturate(150%);
      -webkit-backdrop-filter: blur(60px) saturate(150%);
      border: 1.5px solid rgba(201, 169, 97, 0.3);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 750px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.7), 0 8px 24px rgba(0, 0, 0, 0.5);
    }

    .modal::-webkit-scrollbar { width: 8px; }
    .modal::-webkit-scrollbar-track { background: transparent; }
    .modal::-webkit-scrollbar-thumb {
      background: rgba(201, 169, 97, 0.3);
      border-radius: 4px;
    }

    .modal-header {
      text-align: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(201, 169, 97, 0.2);
    }

    .modal-title {
      font-size: 1.5rem;
      color: #C9A961;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-family: 'Space Grotesk', sans-serif;
    }

    .question-counter {
      text-align: center;
      color: #8e8e93;
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .question-card {
      background: rgba(20, 25, 30, 0.7);
      padding: 1.5rem;
      border-radius: 1rem;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(201, 169, 97, 0.2);
      position: relative;
    }

    .question-category {
      position: absolute;
      top: 1rem;
      right: 1rem;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      background: rgba(201, 169, 97, 0.15);
      color: #C9A961;
      border: 1px solid rgba(201, 169, 97, 0.3);
    }

    .question-text {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      line-height: 1.6;
      color: #e5e5e7;
      font-weight: 500;
      padding-right: 7rem;
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .option-btn {
      padding: 1rem;
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(201, 169, 97, 0.2);
      border-radius: 0.75rem;
      color: #e5e5e7;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .option-btn:hover:not(:disabled) {
      background: rgba(28, 28, 30, 0.95);
      border-color: rgba(201, 169, 97, 0.4);
      transform: translateX(4px);
    }

    .option-btn.selected {
      background: rgba(201, 169, 97, 0.15);
      border-color: #C9A961;
      font-weight: 600;
    }

    .option-btn.correct {
      background: rgba(52, 199, 150, 0.2);
      border-color: #34c796;
      color: #34c796;
      font-weight: 700;
    }

    .option-btn.wrong {
      background: rgba(255, 59, 100, 0.2);
      border-color: #ff3b64;
      color: #ff3b64;
      font-weight: 700;
    }

    .option-btn:disabled { cursor: not-allowed; }

    .feedback {
      margin-top: 0.75rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      display: none;
    }

    .feedback.correct {
      background: rgba(52, 199, 150, 0.15);
      border: 1px solid rgba(52, 199, 150, 0.3);
      color: #34c796;
      display: block;
    }

    .feedback.wrong {
      background: rgba(255, 59, 100, 0.15);
      border: 1px solid rgba(255, 59, 100, 0.3);
      color: #ff3b64;
      display: block;
    }

    .explanation {
      margin-top: 0.5rem;
      padding: 0.75rem;
      background: rgba(201, 169, 97, 0.08);
      border-left: 3px solid #C9A961;
      border-radius: 0.5rem;
      font-size: 0.85rem;
      color: #8e8e93;
      line-height: 1.5;
    }

    .modal-footer {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(201, 169, 97, 0.2);
    }

    .feedback-global {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 1rem 2rem;
      border-radius: 2rem;
      font-weight: 700;
      font-size: 1rem;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 9999;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
    }

    .feedback-global.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .feedback-global.success {
      background: rgba(52, 199, 150, 0.95);
      color: white;
    }

    .feedback-global.error {
      background: rgba(255, 59, 100, 0.95);
      color: white;
    }

    .achievements-panel {
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      padding: 2rem;
      border-radius: 1.5rem;
      border: 1.5px solid rgba(201, 169, 97, 0.25);
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
    }

    .achievement-card {
      background: rgba(20, 25, 30, 0.7);
      padding: 1.5rem;
      border-radius: 1rem;
      text-align: center;
      border: 1px solid rgba(201, 169, 97, 0.2);
      transition: all 0.3s;
    }

    .achievement-card.unlocked {
      background: rgba(201, 169, 97, 0.12);
      border-color: #C9A961;
    }

    .achievement-card:hover.unlocked {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(201, 169, 97, 0.25);
    }

    .achievement-card .achievement-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      filter: grayscale(100%);
      opacity: 0.3;
    }

    .achievement-card.unlocked .achievement-icon {
      filter: none;
      opacity: 1;
    }

    .achievement-card .achievement-name {
      font-size: 0.9rem;
      color: #636366;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .achievement-card.unlocked .achievement-name {
      color: #C9A961;
    }

    .achievement-card .achievement-desc {
      font-size: 0.75rem;
      color: #3a4b6e;
      line-height: 1.3;
    }

    .achievement-card.unlocked .achievement-desc {
      color: #8e8e93;
    }

    @media (max-width: 768px) {
      .header h1 { font-size: 2rem; }
      .scoreboard { flex-direction: column; }
      .player-stats { grid-template-columns: repeat(3, 1fr); }
      .cell { font-size: 2rem; }
      .options-grid { grid-template-columns: 1fr; }
      .profile-badge { 
        position: static; 
        margin: 0 auto 1rem;
        width: fit-content;
      }
      .question-text { padding-right: 1rem; }
      .header { padding-top: 0; }
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="profile-badge" onclick="showAchievements()">
        <span class="achievement-icon">🎓</span>
        <span class="xp-display" id="xpDisplay">Level 1 • 0 XP</span>
      </div>
      <h1>INTUITY</h1>
      <p class="subtitle">C1/C2 Conditionals Master</p>
      <p class="author">by Majid Nashtai</p>
      <div class="cambridge-badge">Advanced & Proficient Level</div>
    </div>

    <div id="modeSelector" class="mode-selector">
      <div class="mode-card" onclick="selectMode('quick')">
        <div class="mode-icon">⚡</div>
        <div class="mode-title">Quick Battle</div>
        <div class="mode-desc">3×3 grid, C1/C2 mixed conditionals</div>
        <div class="mode-stats">
          <div class="stat">
            <div class="stat-value">3×3</div>
            <div class="stat-label">Grid</div>
          </div>
          <div class="stat">
            <div class="stat-value">1</div>
            <div class="stat-label">Round</div>
          </div>
          <div class="stat">
            <div class="stat-value">5</div>
            <div class="stat-label">Q/Cell</div>
          </div>
        </div>
      </div>

      <div class="mode-card" onclick="selectMode('advanced')">
        <div class="mode-icon">🎯</div>
        <div class="mode-title">Advanced Mode</div>
        <div class="mode-desc">Best of 3, complex structures</div>
        <div class="mode-stats">
          <div class="stat">
            <div class="stat-value">3×3</div>
            <div class="stat-label">Grid</div>
          </div>
          <div class="stat">
            <div class="stat-value">3</div>
            <div class="stat-label">Rounds</div>
          </div>
          <div class="stat">
            <div class="stat-value">5</div>
            <div class="stat-label">Q/Cell</div>
          </div>
        </div>
      </div>

      <div class="mode-card" onclick="selectMode('marathon')">
        <div class="mode-icon">🚀</div>
        <div class="mode-title">Conditionals Marathon</div>
        <div class="mode-desc">4×4 grid, timed challenge</div>
        <div class="mode-stats">
          <div class="stat">
            <div class="stat-value">4×4</div>
            <div class="stat-label">Grid</div>
          </div>
          <div class="stat">
            <div class="stat-value">1</div>
            <div class="stat-label">Round</div>
          </div>
          <div class="stat">
            <div class="stat-value">4</div>
            <div class="stat-label">Q/Cell</div>
          </div>
        </div>
      </div>

      <div class="mode-card" onclick="selectMode('custom')">
        <div class="mode-icon">⚙️</div>
        <div class="mode-title">Custom</div>
        <div class="mode-desc">Design your own challenge</div>
        <div class="mode-stats">
          <div class="stat">
            <div class="stat-value">?</div>
            <div class="stat-label">Custom</div>
          </div>
          <div class="stat">
            <div class="stat-value">?</div>
            <div class="stat-label">Custom</div>
          </div>
          <div class="stat">
            <div class="stat-value">?</div>
            <div class="stat-label">Custom</div>
          </div>
        </div>
      </div>
    </div>

    <div id="gameSettings" class="game-settings hidden">
      <h2 style="color: #C9A961; margin-bottom: 1.5rem; text-align: center; text-transform: uppercase; letter-spacing: 2px;">Game Settings</h2>
      
      <div class="settings-grid">
        <div class="setting-group">
          <div class="setting-label">Grid Size</div>
          <div class="setting-value" id="gridSizeValue">3×3</div>
          <input type="range" class="slider" id="gridSizeSlider" min="3" max="5" value="3" oninput="updateGridSize(this.value)">
        </div>

        <div class="setting-group">
          <div class="setting-label">Total Rounds</div>
          <div class="setting-value" id="roundsValue">1</div>
          <input type="range" class="slider" id="roundsSlider" min="1" max="5" value="1" oninput="updateRounds(this.value)">
        </div>

        <div class="setting-group">
          <div class="setting-label">Questions per Cell</div>
          <div class="setting-value" id="questionsValue">5</div>
          <input type="range" class="slider" id="questionsSlider" min="3" max="7" value="5" oninput="updateQuestions(this.value)">
        </div>

        <div class="setting-group">
          <div class="setting-label">Difficulty Level</div>
          <div class="difficulty-selector">
            <button class="difficulty-btn active" onclick="setDifficulty('advanced')">C1</button>
            <button class="difficulty-btn" onclick="setDifficulty('proficient')">C2</button>
          </div>
        </div>

        <div class="setting-group">
          <div class="setting-label">Timer Mode</div>
          <div class="checkbox-group">
            <input type="checkbox" class="checkbox" id="timerCheckbox" onchange="updateTimer(this.checked)">
            <label for="timerCheckbox" style="color: #8e8e93; font-size: 0.9rem;">45s per question</label>
          </div>
        </div>

        <div class="setting-group">
          <div class="setting-label">Power-Ups</div>
          <div class="checkbox-group">
            <input type="checkbox" class="checkbox" id="specialCellsCheckbox" checked onchange="updateSpecialCells(this.checked)">
            <label for="specialCellsCheckbox" style="color: #8e8e93; font-size: 0.9rem;">Enable power-ups</label>
          </div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-secondary" onclick="backToModes()">← Back</button>
        <button class="btn btn-primary" onclick="startGame()">Start Game →</button>
      </div>
    </div>

    <div id="gameArea" class="hidden">
      <div class="timer-container" id="timerContainer">
        <div class="timer-display" id="timerDisplay">45</div>
      </div>

      <div class="round-indicator">
        <div class="round-text" id="roundText">Round 1 of 1</div>
        <div class="round-progress">
          <div class="round-progress-bar" id="roundProgressBar" style="width: 0%"></div>
        </div>
      </div>

      <div class="scoreboard">
        <div class="player-panel" id="panelX">
          <div class="player-emoji">❌</div>
          <div class="player-name">Player X</div>
          <div class="player-stats">
            <div class="player-stat">
              <div class="player-stat-value" id="winsX">0</div>
              <div class="player-stat-label">Rounds Won</div>
            </div>
            <div class="player-stat">
              <div class="player-stat-value" id="cellsX">0</div>
              <div class="player-stat-label">Cells</div>
            </div>
            <div class="player-stat">
              <div class="player-stat-value" id="correctX">0</div>
              <div class="player-stat-label">Correct</div>
            </div>
          </div>
          <div class="powerup-display" id="powerupsX"></div>
        </div>

        <div class="player-panel" id="panelO">
          <div class="player-emoji">⭕</div>
          <div class="player-name">Player O</div>
          <div class="player-stats">
            <div class="player-stat">
              <div class="player-stat-value" id="winsO">0</div>
              <div class="player-stat-label">Rounds Won</div>
            </div>
            <div class="player-stat">
              <div class="player-stat-value" id="cellsO">0</div>
              <div class="player-stat-label">Cells</div>
            </div>
            <div class="player-stat">
              <div class="player-stat-value" id="correctO">0</div>
              <div class="player-stat-label">Correct</div>
            </div>
          </div>
          <div class="powerup-display" id="powerupsO"></div>
        </div>
      </div>

      <div class="board-container">
        <div class="board size-3" id="board"></div>
      </div>

      <div class="controls">
        <button class="btn btn-secondary" onclick="backToMenu()" id="backBtn">← Main Menu</button>
        <button class="btn btn-powerup" onclick="usePowerup('hint')" id="btnHint" disabled>💡 Hint (0)</button>
        <button class="btn btn-powerup" onclick="usePowerup('skip')" id="btnSkip" disabled>⏭️ Skip (0)</button>
        <button class="btn btn-secondary" onclick="forfeitGame()" id="forfeitBtn">Forfeit Round</button>
        <button class="btn btn-primary" onclick="nextRound()" id="nextRoundBtn" style="display: none;">Next Round →</button>
      </div>
    </div>

    <div id="achievementsPanel" class="achievements-panel hidden">
      <h2 style="color: #C9A961; margin-bottom: 1.5rem; text-align: center; text-transform: uppercase; letter-spacing: 2px;">Achievements</h2>
      <div class="achievements-grid" id="achievementsGrid"></div>
      <div class="controls" style="margin-top: 2rem;">
        <button class="btn btn-secondary" onclick="closeAchievements()">← Back</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
    <div class="modal" id="questionModal" onclick="event.stopPropagation()">
      <div id="modalContent"></div>
    </div>
  </div>

  <div class="feedback-global" id="globalFeedback"></div>

  <script>
    // C1/C2 CONDITIONALS QUESTION BANK - British Publication Style
    const QUESTION_BANK = {
      "ZeroFirst": {
        advanced: [
          {q:"If you _____ water to 100°C at standard pressure, it always boils.",opts:["heat","will heat","would heat","heated"],ans:0,exp:"Zero conditional uses present simple in both clauses for universal truths.",cat:"Zero/First"},
          {q:"Should the minister resign, the government _____ into constitutional crisis.",opts:["plunges","will plunge","would plunge","plunged"],ans:1,exp:"Inverted first conditional: 'should + subject' = 'if + present simple', main clause uses 'will'.",cat:"Zero/First"},
          {q:"Unless the board _____ immediate action, shareholders will demand a public inquiry.",opts:["takes","will take","would take","took"],ans:0,exp:"'Unless' means 'if not' and requires present simple in first conditional.",cat:"Zero/First"},
          {q:"If I _____ any further information, I shall contact you immediately.",opts:["will receive","receive","would receive","received"],ans:1,exp:"First conditional: present simple in if-clause, 'shall' (formal) or 'will' in main clause.",cat:"Zero/First"},
          {q:"Provided that parliament _____ the bill, implementation will commence in April.",opts:["approves","will approve","would approve","approved"],ans:0,exp:"'Provided that' (conditional conjunction) takes present simple for future conditions.",cat:"Zero/First"},
          {q:"Should it emerge that funds _____ diverted, regulatory action will follow.",opts:["were","will be","are","would be"],ans:0,exp:"After 'should it emerge that', use past simple (were) for hypothetical discovery.",cat:"Zero/First"},
          {q:"If the accused _____ to appear, a warrant will be issued forthwith.",opts:["fails","will fail","would fail","failed"],ans:0,exp:"First conditional: present simple after 'if' for real future possibility.",cat:"Zero/First"},
          {q:"Unless reform _____ implemented, the system will continue to deteriorate.",opts:["is","will be","would be","were"],ans:0,exp:"'Unless' + present simple passive for real negative condition.",cat:"Zero/First"}
        ],
        proficient: [
          {q:"Were the allegations to prove substantiated, the administration _____ irreparably discredited.",opts:["will be","would be","is","were"],ans:1,exp:"Inverted second conditional: 'were + subject + to-infinitive' (formal hypothetical), main clause uses 'would'.",cat:"Zero/First"},
          {q:"Should it transpire that documents _____ systematically falsified, criminal charges may ensue.",opts:["were","will be","are","would be"],ans:0,exp:"'Should it transpire that' + past simple for discovered past action.",cat:"Zero/First"},
          {q:"If the tribunal _____ to uphold the appeal, precedent would be fundamentally altered.",opts:["is","were","will be","would be"],ans:1,exp:"Subjunctive 'were' (not 'was') in formal hypothetical present condition.",cat:"Zero/First"},
          {q:"Supposing the merger _____ through, thousands of redundancies would inevitably follow.",opts:["goes","went","will go","would go"],ans:1,exp:"'Supposing' (conditional) + past simple for hypothetical future scenario.",cat:"Zero/First"},
          {q:"Were Parliament to be prorogued unexpectedly, a constitutional crisis _____ unavoidable.",opts:["will be","would be","is","were"],ans:1,exp:"Inverted second conditional with 'were + to-infinitive' (formal hypothetical future).",cat:"Zero/First"},
          {q:"Should the electorate _____ differently, the political landscape would be transformed.",opts:["vote","voted","will vote","would vote"],ans:0,exp:"'Should + subject + base form' = inverted first conditional (possible future).",cat:"Zero/First"}
        ]
      },
      "SecondThird": {
        advanced: [
          {q:"If the government _____ earlier, the economic crisis might have been averted.",opts:["acted","had acted","would act","would have acted"],ans:1,exp:"Third conditional: past perfect in if-clause for unreal past condition.",cat:"Second/Third"},
          {q:"Were it not for the intervention of the central bank, the market _____ collapsed entirely.",opts:["will have","would have","had","has"],ans:1,exp:"Inverted second conditional: 'were it not for' (present unreal), main clause 'would have' (past result).",cat:"Second/Third"},
          {q:"If negotiations _____ more productively, an agreement might have been reached.",opts:["proceeded","had proceeded","would proceed","proceed"],ans:1,exp:"Third conditional: past perfect for unreal past action affecting past result.",cat:"Second/Third"},
          {q:"Had the minister _____ transparent, the scandal could have been avoided.",opts:["been","be","is","was"],ans:0,exp:"Inverted third conditional: 'had + subject + past participle'.",cat:"Second/Third"},
          {q:"If the evidence _____ available earlier, the verdict would have differed.",opts:["was","were","had been","would be"],ans:2,exp:"Third conditional: past perfect for unreal past circumstance.",cat:"Second/Third"},
          {q:"Were the prime minister _____ unexpectedly, the deputy would assume office.",opts:["resign","to resign","resigned","resigning"],ans:1,exp:"Inverted second conditional: 'were + subject + to-infinitive' for hypothetical future.",cat:"Second/Third"},
          {q:"If the committee _____ due diligence, the irregularities would have been detected.",opts:["exercised","had exercised","would exercise","exercises"],ans:1,exp:"Third conditional: past perfect for unreal past action.",cat:"Second/Third"},
          {q:"Had whistleblowers not _____ forward, the fraud might never have been exposed.",opts:["come","came","coming","comes"],ans:0,exp:"Inverted third conditional: 'had + subject + past participle'.",cat:"Second/Third"}
        ],
        proficient: [
          {q:"Had it not been for the whistleblower's intervention, the malpractice _____ undetected indefinitely.",opts:["might remain","might have remained","would remain","will have remained"],ans:1,exp:"Inverted third conditional: 'had it not been for' (unreal past), requires perfect conditional 'might have + past participle'.",cat:"Second/Third"},
          {q:"If the allegations _____ substantiated beyond doubt, the implications would be far-reaching.",opts:["was","were","are","had been"],ans:1,exp:"Subjunctive 'were' (not 'was') for formal hypothetical present condition in unreal context.",cat:"Second/Third"},
          {q:"Were successive administrations _____ fiscal prudence, the deficit would not exist today.",opts:["exercise","to have exercised","exercised","exercising"],ans:1,exp:"Mixed conditional: 'were + to have + past participle' (unreal past) → present result.",cat:"Second/Third"},
          {q:"Had the regulators _____ their statutory duty, the systemic failures would have been prevented.",opts:["discharge","discharged","been discharging","to discharge"],ans:1,exp:"Inverted third conditional: 'had + subject + past participle' (formal past unreal).",cat:"Second/Third"},
          {q:"If it _____ for entrenched vested interests, reform would have been implemented long ago.",opts:["wasn't","weren't","hadn't been","isn't"],ans:2,exp:"Third conditional: 'if it hadn't been for' (unreal past reason) → past result with 'would have'.",cat:"Second/Third"},
          {q:"Were the tribunal _____ jurisdiction, the case would proceed to the Supreme Court.",opts:["lack","to lack","lacked","lacking"],ans:1,exp:"Inverted second conditional: 'were + subject + to-infinitive' for hypothetical present.",cat:"Second/Third"}
        ]
      },
      "Mixed": {
        advanced: [
          {q:"If the economic policy _____ implemented differently, unemployment would not be so high today.",opts:["was implemented","had been implemented","would be implemented","were implemented"],ans:1,exp:"Mixed conditional: past perfect (unreal past action) → present conditional result.",cat:"Mixed"},
          {q:"If I _____ that position when offered, I would be working in Brussels now.",opts:["accepted","would accept","had accepted","would have accepted"],ans:2,exp:"Mixed third→second: past perfect for past decision → present conditional result.",cat:"Mixed"},
          {q:"Were I _____ at the time, I would have intervened immediately.",opts:["present","to be present","been present","being present"],ans:0,exp:"Inverted mixed conditional: 'were + subject + adjective' (past context) → past result.",cat:"Mixed"},
          {q:"If she _____ more diplomatic in her approach, relations would not have deteriorated.",opts:["was","were","had been","would be"],ans:2,exp:"Third conditional: past perfect for unreal past behavior → past result.",cat:"Mixed"},
          {q:"Had the infrastructure _____ properly, the current transport crisis would not exist.",opts:["maintain","maintained","been maintaining","been maintained"],ans:3,exp:"Mixed conditional: inverted past perfect passive (past) → present result.",cat:"Mixed"},
          {q:"If successive governments _____ in education, standards would be higher today.",opts:["invested","had invested","would invest","would have invested"],ans:1,exp:"Mixed conditional: past perfect (past inaction) → present consequence.",cat:"Mixed"}
        ],
        proficient: [
          {q:"Had the chancellor _____ greater fiscal prudence earlier, the economy would not be in recession now.",opts:["exercise","exercised","been exercising","have been exercising"],ans:1,exp:"Mixed third→second: inverted past perfect (past action) → present conditional result.",cat:"Mixed"},
          {q:"If successive administrations _____ infrastructure systematically, the transport system would function efficiently today.",opts:["maintained","had maintained","would maintain","would have maintained"],ans:1,exp:"Mixed conditional: past perfect (continuous past failure) → present result.",cat:"Mixed"},
          {q:"Were it not that the defendant _____ a diplomatic passport, extradition proceedings would have commenced.",opts:["holds","held","had held","would hold"],ans:1,exp:"Mixed inverted: 'were it not that' (present fact) → past conditional result.",cat:"Mixed"},
          {q:"Had the electorate _____ more discerningly, the current political impasse would not have arisen.",opts:["vote","voted","been voting","to vote"],ans:1,exp:"Third conditional: inverted past perfect (past action) → past result.",cat:"Mixed"},
          {q:"If the regulatory framework _____ more robust historically, such systemic failures would be unthinkable today.",opts:["was","were","had been","would be"],ans:2,exp:"Mixed conditional: past perfect (past state) → present conditional result.",cat:"Mixed"},
          {q:"Were the opposition _____ a viable alternative previously, the government would have lost the election.",opts:["present","to present","to have presented","presented"],ans:2,exp:"Mixed inverted: 'were + to have + past participle' (unreal past) → past result.",cat:"Mixed"}
        ]
      },
      "Alternatives": {
        advanced: [
          {q:"_____ the minister to resign abruptly, his deputy would assume the portfolio temporarily.",opts:["Should","Would","Could","Were"],ans:3,exp:"Inverted conditional: 'Were + subject + to-infinitive' for formal hypothetical future event.",cat:"Alternatives"},
          {q:"The legislation will not pass _____ the government secures cross-party support.",opts:["if","unless","provided","when"],ans:1,exp:"'Unless' = 'if not'; expresses negative condition (will not pass if support NOT secured).",cat:"Alternatives"},
          {q:"_____ the defendant to be acquitted, public confidence in the judiciary would be severely undermined.",opts:["Should","Were","Had","Would"],ans:1,exp:"'Were + subject + to-infinitive': formal inverted conditional for hypothetical outcome.",cat:"Alternatives"},
          {q:"Negotiations will proceed smoothly _____ both parties demonstrate flexibility.",opts:["unless","provided","were","should"],ans:1,exp:"'Provided' (= 'provided that') expresses positive condition: only if this happens.",cat:"Alternatives"},
          {q:"_____ the board approved the merger, shareholder consent would still be required.",opts:["Should","Were","Had","Even if"],ans:3,exp:"'Even if' + past simple for hypothetical concessive condition (contrasts with main clause).",cat:"Alternatives"},
          {q:"The policy will succeed _____ adequate resources are allocated.",opts:["unless","only if","should","were"],ans:1,exp:"'Only if' (= 'provided that') expresses necessary condition: must have this.",cat:"Alternatives"}
        ],
        proficient: [
          {q:"_____ the tribunal to uphold the original ruling, constitutional precedent would be fundamentally altered.",opts:["Should","Were","Had","Would"],ans:1,exp:"'Were + subject + to-infinitive': formal inverted second conditional for hypothetical future legal outcome.",cat:"Alternatives"},
          {q:"The negotiations might have succeeded _____ both parties shown greater flexibility from the outset.",opts:["should","were","had","if"],ans:2,exp:"'Had + subject + past participle': inverted third conditional (unreal past condition).",cat:"Alternatives"},
          {q:"_____ systemic reform to be implemented comprehensively, decades of entrenched dysfunction must be addressed.",opts:["Were","Should","For","Had"],ans:2,exp:"'For + noun/infinitive + to-infinitive': formal structure expressing necessary condition.",cat:"Alternatives"},
          {q:"The defendant would face prosecution _____ for the diplomatic immunity he currently enjoys.",opts:["if it were not","were it not","had it not been","unless it were"],ans:1,exp:"'Were it not for': inverted second conditional expressing present contrary-to-fact reason.",cat:"Alternatives"},
          {q:"_____ the minister to have resigned earlier, the scandal might never have escalated so dramatically.",opts:["Were","Had","Should","For"],ans:1,exp:"'Had + subject + past participle': inverted third conditional (unreal past action → past result).",cat:"Alternatives"},
          {q:"The policy would never have been adopted _____ for the prime minister's personal intervention.",opts:["were it not","had it not been","should it not be","if it were not"],ans:1,exp:"'Had it not been for': inverted third conditional expressing past contrary-to-fact reason.",cat:"Alternatives"},
          {q:"_____ to the proposal being approved unanimously, implementation will commence immediately.",opts:["Subject","Were","Should","Provided"],ans:0,exp:"'Subject to': formal phrase meaning 'conditional upon' or 'depending on'.",cat:"Alternatives"},
          {q:"Sentencing will be deferred _____ the psychiatric assessment is completed satisfactorily.",opts:["unless","pending","were","should"],ans:1,exp:"'Pending' (= 'until') expresses temporal condition: waiting for this to happen.",cat:"Alternatives"}
        ]
      }
    };

    // ACHIEVEMENTS SYSTEM
    const ACHIEVEMENTS = {
      first_win: {icon:"🎯",name:"First Victory",desc:"Win your first round",unlocked:false},
      perfectionist: {icon:"💯",name:"Perfectionist",desc:"Answer all questions correctly",unlocked:false},
      speed_demon: {icon:"⚡",name:"Speed Demon",desc:"Complete 5 questions in under 60s",unlocked:false},
      comeback_king: {icon:"👑",name:"Comeback King",desc:"Win after being behind",unlocked:false},
      marathon_master: {icon:"🏃",name:"Marathon Master",desc:"Complete a 4×4 grid game",unlocked:false},
      conditionals_guru: {icon:"📚",name:"Conditionals Guru",desc:"Get 50 questions correct",unlocked:false},
      power_player: {icon:"⚡",name:"Power Player",desc:"Use all power-ups in one game",unlocked:false},
      triple_threat: {icon:"🏆",name:"Triple Threat",desc:"Win Best of 3 mode",unlocked:false},
      question_master: {icon:"🎓",name:"Question Master",desc:"Answer 100 questions",unlocked:false},
      streak_master: {icon:"🔥",name:"Streak Master",desc:"Get 10 correct in a row",unlocked:false}
    };

    // GAME STATE
    const GAME = {
      mode: null,
      settings: {
        gridSize: 3,
        totalRounds: 1,
        questionsPerCell: 5,
        timerEnabled: false,
        difficulty: 'advanced',
        specialCellsEnabled: true
      },
      state: {
        currentRound: 1,
        boardState: [],
        cellQuestionSets: {},
        specialCells: [],
        usedQuestionIds: new Set(),
        currentTurn: 'X',
        activeCell: null,
        stats: {
          X: { roundsWon: 0, cellsClaimed: 0, correctAnswers: 0, streak: 0, powerups: {hint: 2, skip: 2} },
          O: { roundsWon: 0, cellsClaimed: 0, correctAnswers: 0, streak: 0, powerups: {hint: 2, skip: 2} }
        },
        timer: null,
        timeLeft: 45,
        activePowerup: null,
        totalQuestionsAnswered: 0,
        questionStartTime: 0
      },
      selectedAnswers: {},
      profile: {
        xp: 0,
        level: 1,
        totalCorrect: 0,
        totalQuestions: 0,
        achievements: JSON.parse(JSON.stringify(ACHIEVEMENTS))
      }
    };

    // Storage functions
    const storage = {
      data: {},
      getItem(key) {
        return this.data[key] || null;
      },
      setItem(key, value) {
        this.data[key] = value;
      }
    };

    function loadProgress() {
      const saved = storage.getItem('intuityConditionalsProgress');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          GAME.profile = {...GAME.profile, ...data};
        } catch(e) {}
      }
      updateXPDisplay();
    }

    function saveProgress() {
      storage.setItem('intuityConditionalsProgress', JSON.stringify(GAME.profile));
    }

    function updateXPDisplay() {
      const level = GAME.profile.level;
      const xp = GAME.profile.xp;
      document.getElementById('xpDisplay').textContent = `Level ${level} • ${xp} XP`;
    }

    function awardXP(amount, reason) {
      GAME.profile.xp += amount;
      const xpForNextLevel = GAME.profile.level * 100;
      
      if (GAME.profile.xp >= xpForNextLevel) {
        GAME.profile.level++;
        GAME.profile.xp = GAME.profile.xp - xpForNextLevel;
        showFeedback(`🎊 Level Up! You're now Level ${GAME.profile.level}!`, false);
      }
      
      updateXPDisplay();
      saveProgress();
    }

    function unlockAchievement(key) {
      if (!GAME.profile.achievements[key].unlocked) {
        GAME.profile.achievements[key].unlocked = true;
        const ach = GAME.profile.achievements[key];
        showFeedback(`🏆 Achievement Unlocked: ${ach.name}!`, false);
        awardXP(50, 'achievement');
        saveProgress();
      }
    }

    function checkAchievements() {
      const stats = GAME.state.stats;
      const currentPlayer = stats[GAME.state.currentTurn];
      
      if ((stats.X.roundsWon > 0 || stats.O.roundsWon > 0) && !GAME.profile.achievements.first_win.unlocked) {
        unlockAchievement('first_win');
      }
      
      if (GAME.settings.gridSize === 4 && !GAME.profile.achievements.marathon_master.unlocked) {
        unlockAchievement('marathon_master');
      }
      
      if (GAME.profile.totalCorrect >= 50 && !GAME.profile.achievements.conditionals_guru.unlocked) {
        unlockAchievement('conditionals_guru');
      }
      
      if (GAME.profile.totalQuestions >= 100 && !GAME.profile.achievements.question_master.unlocked) {
        unlockAchievement('question_master');
      }
      
      if (currentPlayer.streak >= 10 && !GAME.profile.achievements.streak_master.unlocked) {
        unlockAchievement('streak_master');
      }
      
      if (GAME.mode === 'advanced' && (stats.X.roundsWon >= 2 || stats.O.roundsWon >= 2)) {
        unlockAchievement('triple_threat');
      }
    }

    function showAchievements() {
      document.getElementById('modeSelector').classList.add('hidden');
      document.getElementById('achievementsPanel').classList.remove('hidden');
      renderAchievements();
    }

    function closeAchievements() {
      document.getElementById('achievementsPanel').classList.add('hidden');
      document.getElementById('modeSelector').classList.remove('hidden');
    }

    function renderAchievements() {
      const grid = document.getElementById('achievementsGrid');
      grid.innerHTML = '';
      
      Object.keys(GAME.profile.achievements).forEach(key => {
        const ach = GAME.profile.achievements[key];
        const card = document.createElement('div');
        card.className = `achievement-card ${ach.unlocked ? 'unlocked' : ''}`;
        card.innerHTML = `
          <div class="achievement-icon">${ach.icon}</div>
          <div class="achievement-name">${ach.name}</div>
          <div class="achievement-desc">${ach.desc}</div>
        `;
        grid.appendChild(card);
      });
    }

    const MODE_PRESETS = {
      'quick': { gridSize: 3, totalRounds: 1, questionsPerCell: 5, timerEnabled: false, difficulty: 'advanced', specialCellsEnabled: true },
      'advanced': { gridSize: 3, totalRounds: 3, questionsPerCell: 5, timerEnabled: false, difficulty: 'advanced', specialCellsEnabled: true },
      'marathon': { gridSize: 4, totalRounds: 1, questionsPerCell: 4, timerEnabled: true, difficulty: 'proficient', specialCellsEnabled: true },
      'custom': { gridSize: 3, totalRounds: 1, questionsPerCell: 5, timerEnabled: false, difficulty: 'advanced', specialCellsEnabled: true }
    };

    function selectMode(mode) {
      GAME.mode = mode;
      const settings = MODE_PRESETS[mode];
      
      GAME.settings = {...settings};
      
      if (mode === 'custom') {
        document.getElementById('modeSelector').classList.add('hidden');
        document.getElementById('gameSettings').classList.remove('hidden');
        
        document.getElementById('gridSizeSlider').value = settings.gridSize;
        document.getElementById('roundsSlider').value = settings.totalRounds;
        document.getElementById('questionsSlider').value = settings.questionsPerCell;
        document.getElementById('timerCheckbox').checked = settings.timerEnabled;
        document.getElementById('specialCellsCheckbox').checked = settings.specialCellsEnabled;
        
        updateGridSize(settings.gridSize);
        updateRounds(settings.totalRounds);
        updateQuestions(settings.questionsPerCell);
        setDifficulty(settings.difficulty);
      } else {
        startGame();
      }
    }

    function updateGridSize(val) {
      GAME.settings.gridSize = parseInt(val);
      document.getElementById('gridSizeValue').textContent = `${val}×${val}`;
    }

    function updateRounds(val) {
      GAME.settings.totalRounds = parseInt(val);
      document.getElementById('roundsValue').textContent = val;
    }

    function updateQuestions(val) {
      GAME.settings.questionsPerCell = parseInt(val);
      document.getElementById('questionsValue').textContent = val;
    }

    function updateTimer(checked) {
      GAME.settings.timerEnabled = checked;
    }

    function updateSpecialCells(checked) {
      GAME.settings.specialCellsEnabled = checked;
    }

    function setDifficulty(level) {
      GAME.settings.difficulty = level;
      document.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
    }

    function backToModes() {
      document.getElementById('gameSettings').classList.add('hidden');
      document.getElementById('modeSelector').classList.remove('hidden');
    }

    function startGame() {
      const size = GAME.settings.gridSize;
      GAME.state.boardState = Array(size * size).fill(null);
      GAME.state.currentRound = 1;
      GAME.state.currentTurn = 'X';
      GAME.state.cellQuestionSets = {};
      GAME.state.usedQuestionIds.clear();
      GAME.state.totalQuestionsAnswered = 0;
      GAME.state.stats = {
        X: { roundsWon: 0, cellsClaimed: 0, correctAnswers: 0, streak: 0, powerups: {hint: 2, skip: 2} },
        O: { roundsWon: 0, cellsClaimed: 0, correctAnswers: 0, streak: 0, powerups: {hint: 2, skip: 2} }
      };
      
      if (GAME.settings.specialCellsEnabled) {
        const numSpecial = Math.floor(size * size * 0.2);
        GAME.state.specialCells = [];
        while (GAME.state.specialCells.length < numSpecial) {
          const cell = Math.floor(Math.random() * size * size);
          if (!GAME.state.specialCells.includes(cell)) {
            GAME.state.specialCells.push(cell);
          }
        }
      }
      
      document.getElementById('modeSelector').classList.add('hidden');
      document.getElementById('gameSettings').classList.add('hidden');
      document.getElementById('gameArea').classList.remove('hidden');
      
      updateRoundDisplay();
      updateStats();
      updatePowerupButtons();
      renderBoard();
      updateTurnIndicator();
    }

    function renderBoard() {
      const board = document.getElementById('board');
      const size = GAME.settings.gridSize;
      
      board.className = `board size-${size}`;
      board.innerHTML = '';
      
      for (let i = 0; i < size * size; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.cell = i;
        
        if (GAME.state.specialCells.includes(i) && !GAME.state.boardState[i]) {
          cell.classList.add('special-cell');
        }
        
        if (GAME.state.boardState[i]) {
          cell.textContent = GAME.state.boardState[i] === 'X' ? '❌' : '⭕';
          cell.classList.add(`claimed-${GAME.state.boardState[i]}`);
        }
        
        cell.onclick = () => openCellModal(i);
        board.appendChild(cell);
      }
    }

    function getQuestionId(q) {
      return `${q.q}_${q.ans}_${q.cat || 'general'}`;
    }

    function selectFreshQuestions() {
      const difficulty = GAME.settings.difficulty;
      const needed = GAME.settings.questionsPerCell;
      const allQuestions = [];
      
      Object.keys(QUESTION_BANK).forEach(category => {
        const categoryQuestions = QUESTION_BANK[category][difficulty] || [];
        categoryQuestions.forEach(q => {
          allQuestions.push({...q, category});
        });
      });
      
      let available = allQuestions.filter(q => {
        return !GAME.state.usedQuestionIds.has(getQuestionId(q));
      });
      
      if (available.length < needed) {
        GAME.state.usedQuestionIds.clear();
        available = allQuestions;
      }
      
      const shuffled = available.sort(() => Math.random() - 0.5);
      const selected = shuffled.slice(0, needed);
      
      selected.forEach(q => {
        GAME.state.usedQuestionIds.add(getQuestionId(q));
      });
      
      return selected;
    }

    function openCellModal(cellIndex) {
      if (GAME.state.boardState[cellIndex] !== null) {
        showFeedback('⚠️ This cell is already claimed!', true);
        return;
      }
      
      GAME.state.activeCell = cellIndex;
      GAME.state.questionStartTime = Date.now();
      
      // Always generate fresh questions
      GAME.state.cellQuestionSets[cellIndex] = selectFreshQuestions();
      
      const questions = GAME.state.cellQuestionSets[cellIndex];
      renderQuestionModal(questions, cellIndex);
      
      if (GAME.settings.timerEnabled) {
        startTimer();
      }
    }

    function startTimer() {
      GAME.state.timeLeft = 45;
      const container = document.getElementById('timerContainer');
      const display = document.getElementById('timerDisplay');
      
      container.classList.add('show');
      display.textContent = GAME.state.timeLeft;
      display.className = 'timer-display';
      
      clearInterval(GAME.state.timer);
      GAME.state.timer = setInterval(() => {
        GAME.state.timeLeft--;
        display.textContent = GAME.state.timeLeft;
        
        if (GAME.state.timeLeft <= 15) {
          display.className = 'timer-display warning';
        }
        if (GAME.state.timeLeft <= 5) {
          display.className = 'timer-display danger';
        }
        
        if (GAME.state.timeLeft <= 0) {
          clearInterval(GAME.state.timer);
          container.classList.remove('show');
          showFeedback('⏰ Time\'s up!', true);
          closeModal();
          switchTurn();
        }
      }, 1000);
    }

    function stopTimer() {
      clearInterval(GAME.state.timer);
      document.getElementById('timerContainer').classList.remove('show');
    }

    function renderQuestionModal(questions, cellIndex) {
      const overlay = document.getElementById('modalOverlay');
      const content = document.getElementById('modalContent');
      
      const isSpecial = GAME.state.specialCells.includes(cellIndex);
      
      let html = `
        <div class="modal-header">
          <div class="modal-title">Cell ${cellIndex + 1} - ${GAME.state.currentTurn}'s Turn ${isSpecial ? '⭐ BONUS' : ''}</div>
        </div>
        <div class="question-counter">Answer ${GAME.settings.questionsPerCell} questions correctly!</div>
      `;
      
      questions.forEach((q, idx) => {
        html += `
          <div class="question-card" data-q-index="${idx}">
            <div class="question-category">${q.cat || 'Conditionals'}</div>
            <div class="question-text">${idx + 1}. ${q.q}</div>
            <div class="options-grid" id="options-${idx}">
              ${q.opts.map((opt, optIdx) => `
                <button 
                  class="option-btn" 
                  onclick="selectAnswer(${idx}, ${optIdx})"
                  id="opt-${idx}-${optIdx}"
                >
                  ${opt}
                </button>
              `).join('')}
            </div>
            <div class="feedback" id="feedback-${idx}"></div>
          </div>
        `;
      });
      
      html += `
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="submitAnswers()">Submit All</button>
        </div>
      `;
      
      content.innerHTML = html;
      overlay.classList.add('show');
    }

    function selectAnswer(qIndex, optIndex) {
      GAME.selectedAnswers[qIndex] = optIndex;
      
      const card = document.querySelector(`[data-q-index="${qIndex}"]`);
      const buttons = card.querySelectorAll('.option-btn');
      
      buttons.forEach((btn, idx) => {
        btn.classList.remove('selected');
        if (idx === optIndex) {
          btn.classList.add('selected');
        }
      });
    }

    function usePowerup(type) {
      const currentPlayer = GAME.state.stats[GAME.state.currentTurn];
      
      if (type === 'hint') {
        if (currentPlayer.powerups.hint <= 0) {
          showFeedback('❌ No Hint power-ups left!', true);
          return;
        }
        
        currentPlayer.powerups.hint--;
        GAME.state.activePowerup = 'hint';
        
        const questions = GAME.state.cellQuestionSets[GAME.state.activeCell];
        questions.forEach((q, idx) => {
          const correctAns = q.ans;
          const wrongIndices = q.opts.map((_, i) => i).filter(i => i !== correctAns);
          const toRemove = wrongIndices.sort(() => Math.random() - 0.5).slice(0, 2);
          
          toRemove.forEach(optIdx => {
            const btn = document.getElementById(`opt-${idx}-${optIdx}`);
            if (btn) {
              btn.disabled = true;
              btn.style.opacity = '0.3';
            }
          });
        });
        
        showFeedback('💡 Hint activated! 2 wrong answers removed!', false);
        updatePowerupButtons();
      }
      
      if (type === 'skip') {
        if (currentPlayer.powerups.skip <= 0) {
          showFeedback('❌ No Skip power-ups left!', true);
          return;
        }
        
        currentPlayer.powerups.skip--;
        showFeedback('⏭️ Question skipped!', false);
        closeModal();
        updatePowerupButtons();
      }
    }

    function updatePowerupButtons() {
      const currentPlayer = GAME.state.stats[GAME.state.currentTurn];
      
      const btnHint = document.getElementById('btnHint');
      const btnSkip = document.getElementById('btnSkip');
      
      btnHint.textContent = `💡 Hint (${currentPlayer.powerups.hint})`;
      btnHint.disabled = currentPlayer.powerups.hint <= 0;
      
      btnSkip.textContent = `⏭️ Skip (${currentPlayer.powerups.skip})`;
      btnSkip.disabled = currentPlayer.powerups.skip <= 0;
      
      const powerupDisplay = document.getElementById(`powerups${GAME.state.currentTurn}`);
      powerupDisplay.innerHTML = `
        <div class="powerup-item ${currentPlayer.powerups.hint > 0 ? 'active' : ''}">
          💡 ×${currentPlayer.powerups.hint}
        </div>
        <div class="powerup-item ${currentPlayer.powerups.skip > 0 ? 'active' : ''}">
          ⏭️ ×${currentPlayer.powerups.skip}
        </div>
      `;
    }

    function submitAnswers() {
      stopTimer();
      
      const cellIndex = GAME.state.activeCell;
      const questions = GAME.state.cellQuestionSets[cellIndex];
      const isSpecial = GAME.state.specialCells.includes(cellIndex);
      
      let correctCount = 0;
      let allCorrect = true;
      
      questions.forEach((q, idx) => {
        const selected = GAME.selectedAnswers[idx];
        const correct = q.ans;
        const feedback = document.getElementById(`feedback-${idx}`);
        const card = document.querySelector(`[data-q-index="${idx}"]`);
        const buttons = card.querySelectorAll('.option-btn');
        
        buttons.forEach(btn => btn.disabled = true);
        
        GAME.state.totalQuestionsAnswered++;
        GAME.profile.totalQuestions++;
        
        if (selected === correct) {
          correctCount++;
          feedback.innerHTML = `✅ Correct! ${q.exp ? `<div class="explanation">${q.exp}</div>` : ''}`;
          feedback.className = 'feedback correct';
          buttons[selected].classList.add('correct');
          
          GAME.state.stats[GAME.state.currentTurn].streak++;
          GAME.profile.totalCorrect++;
        } else {
          allCorrect = false;
          feedback.innerHTML = `❌ Wrong! Answer: ${q.opts[correct]}${q.exp ? `<div class="explanation">${q.exp}</div>` : ''}`;
          feedback.className = 'feedback wrong';
          if (selected !== undefined) {
            buttons[selected].classList.add('wrong');
          }
          buttons[correct].classList.add('correct');
          
          GAME.state.stats[GAME.state.currentTurn].streak = 0;
        }
      });
      
      const timeBonus = GAME.settings.timerEnabled ? Math.max(0, GAME.state.timeLeft) : 0;
      const baseXP = correctCount * 10;
      const bonusXP = isSpecial ? baseXP : 0;
      const totalXP = baseXP + timeBonus + bonusXP;
      
      awardXP(totalXP, 'questions');
      
      GAME.state.stats[GAME.state.currentTurn].correctAnswers += correctCount;
      
      if (allCorrect && questions.length >= 5) {
        unlockAchievement('perfectionist');
      }
      
      const timeElapsed = (Date.now() - GAME.state.questionStartTime) / 1000;
      if (timeElapsed < 60 && questions.length >= 5 && allCorrect) {
        unlockAchievement('speed_demon');
      }
      
      checkAchievements();
      
      if (correctCount === GAME.settings.questionsPerCell) {
        setTimeout(() => {
          claimCell(cellIndex, isSpecial);
          closeModal();
          checkRoundEnd();
        }, 2500);
      } else {
        setTimeout(() => {
          showFeedback(`❌ ${correctCount}/${GAME.settings.questionsPerCell} correct!`, true);
          switchTurn();
          closeModal();
        }, 3500);
      }
      
      Object.keys(GAME.selectedAnswers).forEach(k => delete GAME.selectedAnswers[k]);
      updateStats();
      updatePowerupButtons();
    }

    function claimCell(cellIndex, isSpecial) {
      GAME.state.boardState[cellIndex] = GAME.state.currentTurn;
      GAME.state.stats[GAME.state.currentTurn].cellsClaimed++;
      
      const cell = document.querySelector(`[data-cell="${cellIndex}"]`);
      cell.textContent = GAME.state.currentTurn === 'X' ? '❌' : '⭕';
      cell.classList.add(`claimed-${GAME.state.currentTurn}`);
      cell.classList.remove('special-cell');
      
      if (isSpecial) {
        showFeedback(`🎉 ${GAME.state.currentTurn} claimed BONUS cell! +1 Power-up!`, false);
        const powerup = Math.random() > 0.5 ? 'hint' : 'skip';
        GAME.state.stats[GAME.state.currentTurn].powerups[powerup]++;
      } else {
        showFeedback(`🎉 ${GAME.state.currentTurn} claimed cell!`, false);
      }
      
      updateStats();
      updatePowerupButtons();
      switchTurn();
    }

    function switchTurn() {
      GAME.state.currentTurn = GAME.state.currentTurn === 'X' ? 'O' : 'X';
      updateTurnIndicator();
      updatePowerupButtons();
    }

    function updateTurnIndicator() {
      document.getElementById('panelX').classList.toggle('active', GAME.state.currentTurn === 'X');
      document.getElementById('panelO').classList.toggle('active', GAME.state.currentTurn === 'O');
    }

    function checkRoundEnd() {
      const size = GAME.settings.gridSize;
      const b = GAME.state.boardState;
      
      const patterns = [];
      
      for (let row = 0; row < size; row++) {
        const pattern = [];
        for (let col = 0; col < size; col++) {
          pattern.push(row * size + col);
        }
        patterns.push(pattern);
      }
      
      for (let col = 0; col < size; col++) {
        const pattern = [];
        for (let row = 0; row < size; row++) {
          pattern.push(row * size + col);
        }
        patterns.push(pattern);
      }
      
      const diag1 = [];
      const diag2 = [];
      for (let i = 0; i < size; i++) {
        diag1.push(i * size + i);
        diag2.push(i * size + (size - 1 - i));
      }
      patterns.push(diag1, diag2);
      
      for (let pattern of patterns) {
        const values = pattern.map(i => b[i]);
        if (values[0] && values.every(v => v === values[0])) {
          handleRoundWin(values[0]);
          return;
        }
      }
      
      if (b.every(cell => cell !== null)) {
        handleRoundDraw();
      }
    }

    function handleRoundWin(winner) {
      GAME.state.stats[winner].roundsWon++;
      updateStats();
      
      const loser = winner === 'X' ? 'O' : 'X';
      if (GAME.state.stats[loser].cellsClaimed > GAME.state.stats[winner].cellsClaimed) {
        unlockAchievement('comeback_king');
      }
      
      awardXP(100, 'round_win');
      
      setTimeout(() => {
        showFeedback(`🏆 ${winner} wins Round ${GAME.state.currentRound}!`, false);
        
        if (GAME.state.currentRound < GAME.settings.totalRounds) {
          document.getElementById('nextRoundBtn').style.display = 'inline-block';
        } else {
          checkMatchWinner();
        }
      }, 1000);
    }

    function handleRoundDraw() {
      setTimeout(() => {
        showFeedback(`🤝 Round ${GAME.state.currentRound} is a draw!`, false);
        
        if (GAME.state.currentRound < GAME.settings.totalRounds) {
          document.getElementById('nextRoundBtn').style.display = 'inline-block';
        } else {
          checkMatchWinner();
        }
      }, 1000);
    }

    function nextRound() {
      GAME.state.currentRound++;
      const size = GAME.settings.gridSize;
      GAME.state.boardState = Array(size * size).fill(null);
      GAME.state.cellQuestionSets = {};
      GAME.state.currentTurn = 'X';
      
      if (GAME.settings.specialCellsEnabled) {
        const numSpecial = Math.floor(size * size * 0.2);
        GAME.state.specialCells = [];
        while (GAME.state.specialCells.length < numSpecial) {
          const cell = Math.floor(Math.random() * size * size);
          if (!GAME.state.specialCells.includes(cell)) {
            GAME.state.specialCells.push(cell);
          }
        }
      }
      
      document.getElementById('nextRoundBtn').style.display = 'none';
      
      updateRoundDisplay();
      renderBoard();
      updateTurnIndicator();
      updatePowerupButtons();
    }

    function checkMatchWinner() {
      const xWins = GAME.state.stats.X.roundsWon;
      const oWins = GAME.state.stats.O.roundsWon;
      
      setTimeout(() => {
        if (xWins > oWins) {
          showFeedback('🎊 PLAYER X WINS THE MATCH! 🎊', false);
          awardXP(200, 'match_win');
        } else if (oWins > xWins) {
          showFeedback('🎊 PLAYER O WINS THE MATCH! 🎊', false);
          awardXP(200, 'match_win');
        } else {
          showFeedback('🤝 MATCH ENDS IN A DRAW! 🤝', false);
          awardXP(100, 'match_draw');
        }
        
        setTimeout(() => {
          const playAgain = confirm('Game Over! Play again?');
          if (playAgain) {
            backToMenu();
          }
        }, 3000);
      }, 2000);
    }

    function updateRoundDisplay() {
      document.getElementById('roundText').textContent = 
        `Round ${GAME.state.currentRound} of ${GAME.settings.totalRounds}`;
      
      const progress = (GAME.state.currentRound / GAME.settings.totalRounds) * 100;
      document.getElementById('roundProgressBar').style.width = `${progress}%`;
    }

    function updateStats() {
      document.getElementById('winsX').textContent = GAME.state.stats.X.roundsWon;
      document.getElementById('cellsX').textContent = GAME.state.stats.X.cellsClaimed;
      document.getElementById('correctX').textContent = GAME.state.stats.X.correctAnswers;
      
      document.getElementById('winsO').textContent = GAME.state.stats.O.roundsWon;
      document.getElementById('cellsO').textContent = GAME.state.stats.O.cellsClaimed;
      document.getElementById('correctO').textContent = GAME.state.stats.O.correctAnswers;
    }

    function forfeitGame() {
      if (confirm('Forfeit this round? The opponent wins this round.')) {
        const opponent = GAME.state.currentTurn === 'X' ? 'O' : 'X';
        GAME.state.stats[opponent].roundsWon++;
        updateStats();
        
        showFeedback(`${opponent} wins Round ${GAME.state.currentRound} by forfeit!`, true);
        
        setTimeout(() => {
          if (GAME.state.currentRound < GAME.settings.totalRounds) {
            if (confirm('Continue to next round?')) {
              nextRound();
            } else {
              backToMenu();
            }
          } else {
            checkMatchWinner();
          }
        }, 2000);
      }
    }

    function backToMenu() {
      if (confirm('Return to main menu? All progress will be lost.')) {
        resetGame();
        stopTimer();
        document.getElementById('gameArea').classList.add('hidden');
        document.getElementById('gameSettings').classList.add('hidden');
        document.getElementById('modeSelector').classList.remove('hidden');
        document.getElementById('nextRoundBtn').style.display = 'none';
      }
    }
    
    function resetGame() {
      const size = GAME.settings.gridSize;
      GAME.state.boardState = Array(size * size).fill(null);
      GAME.state.currentRound = 1;
      GAME.state.currentTurn = 'X';
      GAME.state.cellQuestionSets = {};
      GAME.state.usedQuestionIds.clear();
      GAME.state.specialCells = [];
      GAME.state.stats = {
        X: { roundsWon: 0, cellsClaimed: 0, correctAnswers: 0, streak: 0, powerups: {hint: 2, skip: 2} },
        O: { roundsWon: 0, cellsClaimed: 0, correctAnswers: 0, streak: 0, powerups: {hint: 2, skip: 2} }
      };
      GAME.selectedAnswers = {};
    }

    function closeModal() {
      stopTimer();
      document.getElementById('modalOverlay').classList.remove('show');
      GAME.state.activeCell = null;
      GAME.state.activePowerup = null;
    }

    function showFeedback(msg, isError) {
      const fb = document.getElementById('globalFeedback');
      fb.textContent = msg;
      fb.className = isError ? 'feedback-global error show' : 'feedback-global success show';
      
      setTimeout(() => {
        fb.classList.remove('show');
      }, 3000);
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    window.addEventListener('DOMContentLoaded', () => {
      loadProgress();
      console.log('✅ INTUITY C1/C2 Conditionals Master loaded!');
    });
  </script>
</body>
</html>
