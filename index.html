<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INTUITY - Conditionals Master</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', 'Space Grotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1d3a 100%);
      color: white;
      min-height: 100vh;
      padding: 1rem;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      padding: 1.25rem 0 1rem;
      position: relative;
    }

    .profile-badge {
      position: absolute;
      top: 0;
      right: 1rem;
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 0.5rem 1rem;
      border-radius: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border: 1px solid rgba(201, 169, 97, 0.25);
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .profile-badge:hover {
      background: rgba(28, 28, 30, 0.95);
      border-color: #C9A961;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(201, 169, 97, 0.2);
    }

    .xp-display {
      font-size: 0.75rem;
      color: #C9A961;
      font-weight: 600;
    }

    .header h1 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 2.25rem;
      font-weight: 700;
      color: #C9A961;
      margin-bottom: 0.5rem;
      letter-spacing: -0.04em;
      text-transform: uppercase;
      background: linear-gradient(135deg, #C9A961 0%, rgba(201, 169, 97, 0.8) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header .subtitle {
      font-size: 0.8125rem;
      color: #8e8e93;
      margin-bottom: 0.375rem;
      font-weight: 500;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .header .author {
      font-size: 0.6875rem;
      color: #636366;
      font-weight: 400;
      letter-spacing: 0.02em;
    }

    .level-toggle-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 1.5rem;
      padding: 1rem;
      background: rgba(20, 25, 30, 0.7);
      border-radius: 1rem;
      border: 1px solid rgba(201, 169, 97, 0.2);
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .level-label {
      font-size: 0.875rem;
      color: #8e8e93;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s;
    }

    .level-label.active {
      color: #C9A961;
    }

    .toggle-switch {
      position: relative;
      width: 60px;
      height: 30px;
      background: rgba(201, 169, 97, 0.2);
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid rgba(201, 169, 97, 0.3);
    }

    .toggle-switch:hover {
      border-color: #C9A961;
    }

    .toggle-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: #C9A961;
      border-radius: 50%;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .toggle-switch.c1c2 .toggle-slider {
      transform: translateX(30px);
    }

    .level-description {
      text-align: center;
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: #636366;
      font-style: italic;
    }

    .cambridge-badge {
      display: inline-block;
      background: rgba(201, 169, 97, 0.15);
      padding: 0.5rem 1.5rem;
      border-radius: 2rem;
      border: 1px solid rgba(201, 169, 97, 0.3);
      font-size: 0.75rem;
      color: #C9A961;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-top: 0.5rem;
    }

    .achievement-icon {
      font-size: 1.5rem;
    }

    .mode-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .mode-card {
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      padding: 2rem;
      border-radius: 1.5rem;
      border: 1.5px solid rgba(201, 169, 97, 0.25);
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .mode-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #C9A961, rgba(201, 169, 97, 0.8));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .mode-card:hover::before {
      opacity: 1;
    }

    .mode-card:hover {
      transform: translateY(-8px) scale(1.02);
      border-color: rgba(201, 169, 97, 0.5);
      box-shadow: 0 12px 40px rgba(201, 169, 97, 0.25),
                  0 0 0 1px rgba(201, 169, 97, 0.3),
                  0 4px 16px rgba(0, 0, 0, 0.3);
      background: rgba(28, 28, 30, 0.95);
    }

    .mode-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .mode-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #C9A961;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .mode-desc {
      font-size: 0.9rem;
      color: #8e8e93;
      margin-bottom: 1rem;
      line-height: 1.5;
    }

    .mode-stats {
      display: flex;
      justify-content: space-around;
      padding-top: 1rem;
      border-top: 1px solid rgba(201, 169, 97, 0.2);
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #C9A961;
    }

    .stat-label {
      font-size: 0.75rem;
      color: #636366;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .game-settings {
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      padding: 2rem;
      border-radius: 1.5rem;
      margin-bottom: 2rem;
      border: 1.5px solid rgba(201, 169, 97, 0.25);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .setting-group {
      background: rgba(20, 25, 30, 0.7);
      padding: 1.5rem;
      border-radius: 1rem;
      border: 1px solid rgba(201, 169, 97, 0.2);
    }

    .setting-label {
      font-size: 0.85rem;
      color: #8e8e93;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 0.75rem;
    }

    .setting-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #C9A961;
    }

    .slider {
      width: 100%;
      margin-top: 0.75rem;
      -webkit-appearance: none;
      height: 8px;
      border-radius: 4px;
      background: rgba(201, 169, 97, 0.15);
      outline: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #C9A961;
      cursor: pointer;
      transition: all 0.3s;
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 0 12px rgba(201, 169, 97, 0.8);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.75rem;
    }

    .checkbox {
      width: 24px;
      height: 24px;
      cursor: pointer;
      accent-color: #C9A961;
    }

    .difficulty-selector {
      display: flex;
      gap: 0.75rem;
      margin-top: 0.75rem;
    }

    .difficulty-btn {
      flex: 1;
      padding: 0.5rem;
      background: rgba(20, 25, 30, 0.6);
      border: 1px solid rgba(201, 169, 97, 0.2);
      border-radius: 0.5rem;
      color: #8e8e93;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .difficulty-btn:hover {
      border-color: #C9A961;
    }

    .difficulty-btn.active {
      background: rgba(201, 169, 97, 0.15);
      border-color: #C9A961;
      color: #C9A961;
    }

    .scoreboard {
      display: flex;
      justify-content: space-between;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .player-panel {
      flex: 1;
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      padding: 2rem;
      border-radius: 1.5rem;
      border: 1.5px solid rgba(201, 169, 97, 0.25);
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .player-panel.active {
      border-color: #C9A961;
      box-shadow: 0 0 32px rgba(201, 169, 97, 0.3);
    }

    .player-panel.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #C9A961, rgba(201, 169, 97, 0.8));
      animation: glow 2s ease-in-out infinite;
    }

    @keyframes glow {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }

    .player-emoji {
      font-size: 4rem;
      text-align: center;
      margin-bottom: 1rem;
    }

    .player-name {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      color: #C9A961;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 1.5rem;
    }

    .player-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    .player-stat {
      text-align: center;
      padding: 1rem;
      background: rgba(20, 25, 30, 0.7);
      border-radius: 0.75rem;
    }

    .player-stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: #C9A961;
    }

    .player-stat-label {
      font-size: 0.7rem;
      color: #636366;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 0.25rem;
    }

    .powerup-display {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(201, 169, 97, 0.2);
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .powerup-item {
      background: rgba(20, 25, 30, 0.7);
      padding: 0.5rem 1rem;
      border-radius: 1rem;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border: 1px solid rgba(201, 169, 97, 0.2);
    }

    .powerup-item.active {
      background: rgba(201, 169, 97, 0.15);
      border-color: #C9A961;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .round-indicator {
      text-align: center;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: rgba(201, 169, 97, 0.08);
      border-radius: 1rem;
      border: 1px solid rgba(201, 169, 97, 0.25);
    }

    .round-text {
      font-size: 1.25rem;
      font-weight: 700;
      color: #C9A961;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .round-progress {
      margin-top: 1rem;
      height: 12px;
      background: rgba(201, 169, 97, 0.15);
      border-radius: 6px;
      overflow: hidden;
    }

    .round-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #C9A961, rgba(201, 169, 97, 0.8));
      border-radius: 6px;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .board-container {
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      padding: 2rem;
      border-radius: 1.5rem;
      border: 1.5px solid rgba(201, 169, 97, 0.25);
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .board {
      display: grid;
      gap: 1rem;
      margin: 0 auto;
      max-width: 600px;
    }

    .board.size-3 { grid-template-columns: repeat(3, 1fr); }
    .board.size-4 { grid-template-columns: repeat(4, 1fr); }
    .board.size-5 { grid-template-columns: repeat(5, 1fr); }

    .cell {
      aspect-ratio: 1;
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 2px solid rgba(201, 169, 97, 0.25);
      border-radius: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .cell::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(201, 169, 97, 0.15), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .cell:hover:not(.claimed-X):not(.claimed-O):not(.special-cell)::before {
      opacity: 1;
    }

    .cell:hover:not(.claimed-X):not(.claimed-O) {
      transform: scale(1.05);
      border-color: rgba(201, 169, 97, 0.5);
      box-shadow: 0 8px 24px rgba(201, 169, 97, 0.25);
    }

    .cell.claimed-X {
      background: rgba(255, 59, 100, 0.2);
      border-color: #ff3b64;
      cursor: not-allowed;
    }

    .cell.claimed-O {
      background: rgba(52, 199, 150, 0.2);
      border-color: #34c796;
      cursor: not-allowed;
    }

    .cell.special-cell {
      background: linear-gradient(135deg, rgba(201, 169, 97, 0.15), rgba(201, 169, 97, 0.08));
      border-color: #C9A961;
      animation: specialGlow 3s ease-in-out infinite;
    }

    .cell.special-cell::after {
      content: '‚≠ê';
      position: absolute;
      top: 0.25rem;
      right: 0.25rem;
      font-size: 1rem;
    }

    @keyframes specialGlow {
      0%, 100% { box-shadow: 0 0 20px rgba(201, 169, 97, 0.3); }
      50% { box-shadow: 0 0 40px rgba(201, 169, 97, 0.5); }
    }

    .timer-container {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(28, 28, 30, 0.95);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      padding: 1rem 2rem;
      border-radius: 2rem;
      border: 1.5px solid rgba(201, 169, 97, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      display: none;
    }

    .timer-container.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateX(-50%) translateY(-100px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    .timer-display {
      font-size: 2rem;
      font-weight: 700;
      color: #C9A961;
      text-align: center;
    }

    .timer-display.warning {
      color: #ff9500;
      animation: timerPulse 1s ease-in-out infinite;
    }

    .timer-display.danger {
      color: #ff3b30;
      animation: timerPulse 0.5s ease-in-out infinite;
    }

    @keyframes timerPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 1rem 2rem;
      border: none;
      border-radius: 0.75rem;
      font-weight: 700;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .btn-primary {
      background: linear-gradient(135deg, #C9A961 0%, rgba(201, 169, 97, 0.85) 100%);
      color: white;
      box-shadow: 0 4px 16px rgba(201, 169, 97, 0.25);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(201, 169, 97, 0.4);
    }

    .btn-primary:active {
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: rgba(28, 28, 30, 0.85);
      border: 1px solid rgba(201, 169, 97, 0.25);
      color: #e5e5e7;
    }

    .btn-secondary:hover {
      background: rgba(28, 28, 30, 0.95);
      border-color: rgba(201, 169, 97, 0.4);
      transform: translateY(-2px);
    }

    .btn-secondary:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-powerup {
      background: rgba(201, 169, 97, 0.15);
      border: 1px solid #C9A961;
      color: #C9A961;
      padding: 0.75rem 1.5rem;
      font-size: 0.9rem;
    }

    .btn-powerup:hover:not(:disabled) {
      background: rgba(201, 169, 97, 0.25);
      transform: translateY(-2px);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      z-index: 999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: rgba(28, 28, 30, 0.98);
      backdrop-filter: blur(60px) saturate(150%);
      -webkit-backdrop-filter: blur(60px) saturate(150%);
      border: 1.5px solid rgba(201, 169, 97, 0.3);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 750px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.7), 0 8px 24px rgba(0, 0, 0, 0.5);
    }

    .modal::-webkit-scrollbar { width: 8px; }
    .modal::-webkit-scrollbar-track { background: transparent; }
    .modal::-webkit-scrollbar-thumb {
      background: rgba(201, 169, 97, 0.3);
      border-radius: 4px;
    }

    .modal-header {
      text-align: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(201, 169, 97, 0.2);
    }

    .modal-title {
      font-size: 1.5rem;
      color: #C9A961;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-family: 'Space Grotesk', sans-serif;
    }

    .question-counter {
      text-align: center;
      color: #8e8e93;
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .question-card {
      background: rgba(20, 25, 30, 0.7);
      padding: 1.5rem;
      border-radius: 1rem;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(201, 169, 97, 0.2);
      position: relative;
    }

    .question-category {
      position: absolute;
      top: 1rem;
      right: 1rem;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      background: rgba(201, 169, 97, 0.15);
      color: #C9A961;
      border: 1px solid rgba(201, 169, 97, 0.3);
    }

    .question-text {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      line-height: 1.6;
      color: #e5e5e7;
      font-weight: 500;
      padding-right: 7rem;
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .option-btn {
      padding: 1rem;
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(201, 169, 97, 0.2);
      border-radius: 0.75rem;
      color: #e5e5e7;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .option-btn:hover:not(:disabled) {
      background: rgba(28, 28, 30, 0.95);
      border-color: rgba(201, 169, 97, 0.4);
      transform: translateX(4px);
    }

    .option-btn.selected {
      background: rgba(201, 169, 97, 0.15);
      border-color: #C9A961;
      font-weight: 600;
    }

    .option-btn.correct {
      background: rgba(52, 199, 150, 0.3) !important;
      border-color: #34c796 !important;
      color: #34c796 !important;
      font-weight: 700;
    }

    .option-btn.wrong {
      background: rgba(255, 149, 0, 0.3) !important;
      border-color: #ff9500 !important;
      color: #ff9500 !important;
      font-weight: 700;
    }

    .option-btn:disabled { cursor: not-allowed; }

    .feedback {
      margin-top: 0.75rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      display: none;
    }

    .feedback.correct {
      background: rgba(52, 199, 150, 0.15);
      border: 1px solid rgba(52, 199, 150, 0.3);
      color: #34c796;
      display: block;
    }

    .feedback.wrong {
      background: rgba(255, 149, 0, 0.15);
      border: 1px solid rgba(255, 149, 0, 0.3);
      color: #ff9500;
      display: block;
    }

    .explanation {
      margin-top: 0.5rem;
      padding: 0.75rem;
      background: rgba(201, 169, 97, 0.08);
      border-left: 3px solid #C9A961;
      border-radius: 0.5rem;
      font-size: 0.85rem;
      color: #8e8e93;
      line-height: 1.5;
    }

    .modal-footer {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(201, 169, 97, 0.2);
    }

    .feedback-global {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 1rem 2rem;
      border-radius: 2rem;
      font-weight: 700;
      font-size: 1rem;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 9999;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
    }

    .feedback-global.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .feedback-global.success {
      background: rgba(52, 199, 150, 0.95);
      color: white;
    }

    .feedback-global.error {
      background: rgba(255, 59, 100, 0.95);
      color: white;
    }

    .achievements-panel {
      background: rgba(28, 28, 30, 0.85);
      backdrop-filter: blur(40px) saturate(150%);
      -webkit-backdrop-filter: blur(40px) saturate(150%);
      padding: 2rem;
      border-radius: 1.5rem;
      border: 1.5px solid rgba(201, 169, 97, 0.25);
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
    }

    .achievement-card {
      background: rgba(20, 25, 30, 0.7);
      padding: 1.5rem;
      border-radius: 1rem;
      text-align: center;
      border: 1px solid rgba(201, 169, 97, 0.2);
      transition: all 0.3s;
    }

    .achievement-card.unlocked {
      background: rgba(201, 169, 97, 0.12);
      border-color: #C9A961;
    }

    .achievement-card:hover.unlocked {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(201, 169, 97, 0.25);
    }

    .achievement-card .achievement-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      filter: grayscale(100%);
      opacity: 0.3;
    }

    .achievement-card.unlocked .achievement-icon {
      filter: none;
      opacity: 1;
    }

    .achievement-card .achievement-name {
      font-size: 0.9rem;
      color: #636366;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .achievement-card.unlocked .achievement-name {
      color: #C9A961;
    }

    .achievement-card .achievement-desc {
      font-size: 0.75rem;
      color: #3a4b6e;
      line-height: 1.3;
    }

    .achievement-card.unlocked .achievement-desc {
      color: #8e8e93;
    }

    @media (max-width: 768px) {
      .header h1 { font-size: 2rem; }
      .scoreboard { flex-direction: column; }
      .player-stats { grid-template-columns: repeat(3, 1fr); }
      .cell { font-size: 2rem; }
      .options-grid { grid-template-columns: 1fr; }
      .profile-badge { 
        position: static; 
        margin: 0 auto 1rem;
        width: fit-content;
      }
      .question-text { padding-right: 1rem; }
      .header { padding-top: 0; }
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="profile-badge" onclick="showAchievements()">
        <span class="achievement-icon">üéì</span>
        <span class="xp-display" id="xpDisplay">Level 1 ‚Ä¢ 0 XP</span>
      </div>
      <h1>INTUITY</h1>
      <p class="subtitle">Conditionals Master</p>
      <p class="author">by Majid Nashtai</p>
      
      <!-- Level Toggle -->
      <div class="level-toggle-container">
        <span class="level-label active" id="labelB2">B2</span>
        <div class="toggle-switch" id="levelToggle" onclick="toggleLevel()">
          <div class="toggle-slider"></div>
        </div>
        <span class="level-label" id="labelC1C2">C1/C2</span>
      </div>
      <div class="level-description" id="levelDesc">Upper Intermediate</div>
      
      <div class="cambridge-badge" id="cambridgeBadge">Intermediate Level</div>
    </div>

    <div id="modeSelector" class="mode-selector">
      <div class="mode-card" onclick="selectMode('quick')">
        <div class="mode-icon">‚ö°</div>
        <div class="mode-title">Quick Battle</div>
        <div class="mode-desc">3√ó3 grid, mixed conditionals</div>
        <div class="mode-stats">
          <div class="stat">
            <div class="stat-value">3√ó3</div>
            <div class="stat-label">Grid</div>
          </div>
          <div class="stat">
            <div class="stat-value">1</div>
            <div class="stat-label">Round</div>
          </div>
          <div class="stat">
            <div class="stat-value">5</div>
            <div class="stat-label">Q/Cell</div>
          </div>
        </div>
      </div>

      <div class="mode-card" onclick="selectMode('advanced')">
        <div class="mode-icon">üéØ</div>
        <div class="mode-title">Advanced Mode</div>
        <div class="mode-desc">Best of 3, complex structures</div>
        <div class="mode-stats">
          <div class="stat">
            <div class="stat-value">3√ó3</div>
            <div class="stat-label">Grid</div>
          </div>
          <div class="stat">
            <div class="stat-value">3</div>
            <div class="stat-label">Rounds</div>
          </div>
          <div class="stat">
            <div class="stat-value">5</div>
            <div class="stat-label">Q/Cell</div>
          </div>
        </div>
      </div>

      <div class="mode-card" onclick="selectMode('marathon')">
        <div class="mode-icon">üöÄ</div>
        <div class="mode-title">Conditionals Marathon</div>
        <div class="mode-desc">4√ó4 grid, timed challenge</div>
        <div class="mode-stats">
          <div class="stat">
            <div class="stat-value">4√ó4</div>
            <div class="stat-label">Grid</div>
          </div>
          <div class="stat">
            <div class="stat-value">1</div>
            <div class="stat-label">Round</div>
          </div>
          <div class="stat">
            <div class="stat-value">4</div>
            <div class="stat-label">Q/Cell</div>
          </div>
        </div>
      </div>

      <div class="mode-card" onclick="selectMode('custom')">
        <div class="mode-icon">‚öôÔ∏è</div>
        <div class="mode-title">Custom</div>
        <div class="mode-desc">Design your own challenge</div>
        <div class="mode-stats">
          <div class="stat">
            <div class="stat-value">?</div>
            <div class="stat-label">Custom</div>
          </div>
          <div class="stat">
            <div class="stat-value">?</div>
            <div class="stat-label">Custom</div>
          </div>
          <div class="stat">
            <div class="stat-value">?</div>
            <div class="stat-label">Custom</div>
          </div>
        </div>
      </div>
    </div>

    <div id="gameSettings" class="game-settings hidden">
      <h2 style="color: #C9A961; margin-bottom: 1.5rem; text-align: center; text-transform: uppercase; letter-spacing: 2px;">Game Settings</h2>
      
      <div class="settings-grid">
        <div class="setting-group">
          <div class="setting-label">Grid Size</div>
          <div class="setting-value" id="gridSizeValue">3√ó3</div>
          <input type="range" class="slider" id="gridSizeSlider" min="3" max="5" value="3" oninput="updateGridSize(this.value)">
        </div>

        <div class="setting-group">
          <div class="setting-label">Total Rounds</div>
          <div class="setting-value" id="roundsValue">1</div>
          <input type="range" class="slider" id="roundsSlider" min="1" max="5" value="1" oninput="updateRounds(this.value)">
        </div>

        <div class="setting-group">
          <div class="setting-label">Questions per Cell</div>
          <div class="setting-value" id="questionsValue">5</div>
          <input type="range" class="slider" id="questionsSlider" min="3" max="7" value="5" oninput="updateQuestions(this.value)">
        </div>

        <div class="setting-group">
          <div class="setting-label">Difficulty Level</div>
          <div class="difficulty-selector" id="difficultySelector">
            <button class="difficulty-btn active" onclick="setDifficulty('intermediate')">B2.1</button>
            <button class="difficulty-btn" onclick="setDifficulty('upper')">B2.2</button>
          </div>
        </div>

        <div class="setting-group">
          <div class="setting-label">Timer Mode</div>
          <div class="checkbox-group">
            <input type="checkbox" class="checkbox" id="timerCheckbox" onchange="updateTimer(this.checked)">
            <label for="timerCheckbox" style="color: #8e8e93; font-size: 0.9rem;">45s per question</label>
          </div>
        </div>

        <div class="setting-group">
          <div class="setting-label">Power-Ups</div>
          <div class="checkbox-group">
            <input type="checkbox" class="checkbox" id="specialCellsCheckbox" checked onchange="updateSpecialCells(this.checked)">
            <label for="specialCellsCheckbox" style="color: #8e8e93; font-size: 0.9rem;">Enable power-ups</label>
          </div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-secondary" onclick="backToModes()">‚Üê Back</button>
        <button class="btn btn-primary" onclick="startGame()">Start Game ‚Üí</button>
      </div>
    </div>

    <div id="gameArea" class="hidden">
      <div class="timer-container" id="timerContainer">
        <div class="timer-display" id="timerDisplay">45</div>
      </div>

      <div class="round-indicator">
        <div class="round-text" id="roundText">Round 1 of 1</div>
        <div class="round-progress">
          <div class="round-progress-bar" id="roundProgressBar" style="width: 0%"></div>
        </div>
      </div>

      <div class="scoreboard">
        <div class="player-panel" id="panelX">
          <div class="player-emoji">‚ùå</div>
          <div class="player-name">Player X</div>
          <div class="player-stats">
            <div class="player-stat">
              <div class="player-stat-value" id="winsX">0</div>
              <div class="player-stat-label">Rounds Won</div>
            </div>
            <div class="player-stat">
              <div class="player-stat-value" id="cellsX">0</div>
              <div class="player-stat-label">Cells</div>
            </div>
            <div class="player-stat">
              <div class="player-stat-value" id="correctX">0</div>
              <div class="player-stat-label">Correct</div>
            </div>
          </div>
          <div class="powerup-display" id="powerupsX"></div>
        </div>

        <div class="player-panel" id="panelO">
          <div class="player-emoji">‚≠ï</div>
          <div class="player-name">Player O</div>
          <div class="player-stats">
            <div class="player-stat">
              <div class="player-stat-value" id="winsO">0</div>
              <div class="player-stat-label">Rounds Won</div>
            </div>
            <div class="player-stat">
              <div class="player-stat-value" id="cellsO">0</div>
              <div class="player-stat-label">Cells</div>
            </div>
            <div class="player-stat">
              <div class="player-stat-value" id="correctO">0</div>
              <div class="player-stat-label">Correct</div>
            </div>
          </div>
          <div class="powerup-display" id="powerupsO"></div>
        </div>
      </div>

      <div class="board-container">
        <div class="board size-3" id="board"></div>
      </div>

      <div class="controls">
        <button class="btn btn-secondary" onclick="backToMenu()" id="backBtn">‚Üê Main Menu</button>
        <button class="btn btn-powerup" onclick="usePowerup('hint')" id="btnHint" disabled>üí° Hint (0)</button>
        <button class="btn btn-powerup" onclick="usePowerup('skip')" id="btnSkip" disabled>‚è≠Ô∏è Skip (0)</button>
        <button class="btn btn-secondary" onclick="forfeitGame()" id="forfeitBtn">Forfeit Round</button>
        <button class="btn btn-primary" onclick="nextRound()" id="nextRoundBtn" style="display: none;">Next Round ‚Üí</button>
      </div>
    </div>

    <div id="achievementsPanel" class="achievements-panel hidden">
      <h2 style="color: #C9A961; margin-bottom: 1.5rem; text-align: center; text-transform: uppercase; letter-spacing: 2px;">Achievements</h2>
      <div class="achievements-grid" id="achievementsGrid"></div>
      <div class="controls" style="margin-top: 2rem;">
        <button class="btn btn-secondary" onclick="closeAchievements()">‚Üê Back</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
    <div class="modal" id="questionModal" onclick="event.stopPropagation()">
      <div id="modalContent"></div>
    </div>
  </div>

  <div class="feedback-global" id="globalFeedback"></div>

  <script>
    // GLOBAL STATE
    let QUESTION_BANK = {};
    let CURRENT_LEVEL = 'b2'; // 'b2' or 'c1c2'
    
    // Level configurations
    const LEVEL_CONFIG = {
      b2: {
        jsonFile: 'questions-b2.json',
        badge: 'Intermediate Level',
        description: 'Upper Intermediate',
        difficultyLevels: ['intermediate', 'upper'],
        difficultyLabels: { intermediate: 'B2.1', upper: 'B2.2' }
      },
      c1c2: {
        jsonFile: 'questions-c1c2.json',
        badge: 'Advanced & Proficient Level',
        description: 'Advanced & Proficient',
        difficultyLevels: ['advanced', 'proficient'],
        difficultyLabels: { advanced: 'C1', proficient: 'C2' }
      }
    };

    // Load questions from JSON
    async function loadQuestions(level) {
      try {
        const config = LEVEL_CONFIG[level];
        const response = await fetch(config.jsonFile);
        if (!response.ok) throw new Error(`Failed to load ${config.jsonFile}`);
        QUESTION_BANK = await response.json();
        console.log(`‚úÖ Loaded ${level.toUpperCase()} questions`);
      } catch (error) {
        console.error('Error loading questions:', error);
        alert('Failed to load questions. Please ensure questions-b2.json and questions-c1c2.json are in the same directory as this HTML file.');
      }
    }

    // Toggle between B2 and C1/C2
    async function toggleLevel() {
      const toggle = document.getElementById('levelToggle');
      const labelB2 = document.getElementById('labelB2');
      const labelC1C2 = document.getElementById('labelC1C2');
      const badge = document.getElementById('cambridgeBadge');
      const desc = document.getElementById('levelDesc');
      
      // Toggle state
      CURRENT_LEVEL = CURRENT_LEVEL === 'b2' ? 'c1c2' : 'b2';
      const config = LEVEL_CONFIG[CURRENT_LEVEL];
      
      // Update UI
      toggle.classList.toggle('c1c2');
      
      if (CURRENT_LEVEL === 'c1c2') {
        labelB2.classList.remove('active');
        labelC1C2.classList.add('active');
      } else {
        labelB2.classList.add('active');
        labelC1C2.classList.remove('active');
      }
      
      badge.textContent = config.badge;
      desc.textContent = config.description;
      
      // Load new questions
      await loadQuestions(CURRENT_LEVEL);
      
      // Reset game if in progress
      if (!document.getElementById('gameArea').classList.contains('hidden')) {
        if (confirm('Changing level will reset the current game. Continue?')) {
          backToMenu();
        } else {
          // Revert toggle
          CURRENT_LEVEL = CURRENT_LEVEL === 'b2' ? 'c1c2' : 'b2';
          toggle.classList.toggle('c1c2');
          
          if (CURRENT_LEVEL === 'c1c2') {
            labelB2.classList.remove('active');
            labelC1C2.classList.add('active');
          } else {
            labelB2.classList.add('active');
            labelC1C2.classList.remove('active');
          }
          
          badge.textContent = LEVEL_CONFIG[CURRENT_LEVEL].badge;
          desc.textContent = LEVEL_CONFIG[CURRENT_LEVEL].description;
        }
      }
      
      // Update difficulty buttons
      updateDifficultyButtons();
    }

    function updateDifficultyButtons() {
      const config = LEVEL_CONFIG[CURRENT_LEVEL];
      const diffSelector = document.getElementById('difficultySelector');
      
      if (diffSelector) {
        const buttons = config.difficultyLevels.map((level, idx) => {
          const label = config.difficultyLabels[level];
          const active = idx === 0 ? 'active' : '';
          return `<button class="difficulty-btn ${active}" onclick="setDifficulty('${level}')">${label}</button>`;
        }).join('');
        
        diffSelector.innerHTML = buttons;
      }
    }

    function setDifficulty(level) {
      GAME.settings.difficulty = level;
      document.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
    }

    function getDefaultDifficulty() {
      return LEVEL_CONFIG[CURRENT_LEVEL].difficultyLevels[0];
    }

    const MODE_PRESETS = {
      'quick': () => ({ 
        gridSize: 3, 
        totalRounds: 1, 
        questionsPerCell: 5, 
        timerEnabled: false, 
        difficulty: getDefaultDifficulty(), 
        specialCellsEnabled: true 
      }),
      'advanced': () => ({ 
        gridSize: 3, 
        totalRounds: 3, 
        questionsPerCell: 5, 
        timerEnabled: false, 
        difficulty: getDefaultDifficulty(), 
        specialCellsEnabled: true 
      }),
      'marathon': () => ({ 
        gridSize: 4, 
        totalRounds: 1, 
        questionsPerCell: 4, 
        timerEnabled: true, 
        difficulty: LEVEL_CONFIG[CURRENT_LEVEL].difficultyLevels[1], 
        specialCellsEnabled: true 
      }),
      'custom': () => ({ 
        gridSize: 3, 
        totalRounds: 1, 
        questionsPerCell: 5, 
        timerEnabled: false, 
        difficulty: getDefaultDifficulty(), 
        specialCellsEnabled: true 
      })
    };

    function selectMode(mode) {
      GAME.mode = mode;
      const settings = MODE_PRESETS[mode]();
      
      GAME.settings = {...settings};
      
      if (mode === 'custom') {
        document.getElementById('modeSelector').classList.add('hidden');
        document.getElementById('gameSettings').classList.remove('hidden');
        
        document.getElementById('gridSizeSlider').value = settings.gridSize;
        document.getElementById('roundsSlider').value = settings.totalRounds;
        document.getElementById('questionsSlider').value = settings.questionsPerCell;
        document.getElementById('timerCheckbox').checked = settings.timerEnabled;
        document.getElementById('specialCellsCheckbox').checked = settings.specialCellsEnabled;
        
        updateGridSize(settings.gridSize);
        updateRounds(settings.totalRounds);
        updateQuestions(settings.questionsPerCell);
        updateDifficultyButtons();
        setDifficultyProgrammatically(settings.difficulty);
      } else {
        startGame();
      }
    }

    function setDifficultyProgrammatically(level) {
      GAME.settings.difficulty = level;
      document.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === LEVEL_CONFIG[CURRENT_LEVEL].difficultyLabels[level]) {
          btn.classList.add('active');
        }
      });
    }

    function getStorageKey() {
      return `intuityConditionalsProgress_${CURRENT_LEVEL}`;
    }

    // ACHIEVEMENTS SYSTEM
    const ACHIEVEMENTS = {
      first_win: {icon:"üéØ",name:"First Victory",desc:"Win your first round",unlocked:false},
      perfectionist: {icon:"üíØ",name:"Perfectionist",desc:"Answer all questions correctly",unlocked:false},
      speed_demon: {icon:"‚ö°",name:"Speed Demon",desc:"Complete 5 questions in under 60s",unlocked:false},
      comeback_king: {icon:"üëë",name:"Comeback King",desc:"Win after being behind",unlocked:false},
      marathon_master: {icon:"üèÉ",name:"Marathon Master",desc:"Complete a 4√ó4 grid game",unlocked:false},
      conditionals_guru: {icon:"üìö",name:"Conditionals Guru",desc:"Get 50 questions correct",unlocked:false},
      power_player: {icon:"‚ö°",name:"Power Player",desc:"Use all power-ups in one game",unlocked:false},
      triple_threat: {icon:"üèÜ",name:"Triple Threat",desc:"Win Best of 3 mode",unlocked:false},
      question_master: {icon:"üéì",name:"Question Master",desc:"Answer 100 questions",unlocked:false},
      streak_master: {icon:"üî•",name:"Streak Master",desc:"Get 10 correct in a row",unlocked:false}
    };

    // GAME STATE
    const GAME = {
      mode: null,
      settings: {
        gridSize: 3,
        totalRounds: 1,
        questionsPerCell: 5,
        timerEnabled: false,
        difficulty: 'intermediate',
        specialCellsEnabled: true
      },
      state: {
        currentRound: 1,
        boardState: [],
        cellQuestionSets: {},
        specialCells: [],
        usedQuestionIds: new Set(),
        currentTurn: 'X',
        activeCell: null,
        stats: {
          X: { roundsWon: 0, cellsClaimed: 0, correctAnswers: 0, streak: 0, powerups: {hint: 2, skip: 2} },
          O: { roundsWon: 0, cellsClaimed: 0, correctAnswers: 0, streak: 0, powerups: {hint: 2, skip: 2} }
        },
        timer: null,
        timeLeft: 45,
        activePowerup: null,
        totalQuestionsAnswered: 0,
        questionStartTime: 0
      },
      selectedAnswers: {},
      profile: {
        xp: 0,
        level: 1,
        totalCorrect: 0,
        totalQuestions: 0,
        achievements: JSON.parse(JSON.stringify(ACHIEVEMENTS))
      }
    };

    // Storage functions
    const storage = {
      data: {},
      getItem(key) {
        return this.data[key] || null;
      },
      setItem(key, value) {
        this.data[key] = value;
      }
    };

    function loadProgress() {
      const saved = storage.getItem(getStorageKey());
      if (saved) {
        try {
          const data = JSON.parse(saved);
          GAME.profile = {...GAME.profile, ...data};
        } catch(e) {}
      }
      updateXPDisplay();
    }

    function saveProgress() {
      storage.setItem(getStorageKey(), JSON.stringify(GAME.profile));
    }

    function updateXPDisplay() {
      const level = GAME.profile.level;
      const xp = GAME.profile.xp;
      document.getElementById('xpDisplay').textContent = `Level ${level} ‚Ä¢ ${xp} XP`;
    }

    function awardXP(amount, reason) {
      GAME.profile.xp += amount;
      const xpForNextLevel = GAME.profile.level * 100;
      
      if (GAME.profile.xp >= xpForNextLevel) {
        GAME.profile.level++;
        GAME.profile.xp = GAME.profile.xp - xpForNextLevel;
        showFeedback(`üéä Level Up! You're now Level ${GAME.profile.level}!`, false);
      }
      
      updateXPDisplay();
      saveProgress();
    }

    function unlockAchievement(key) {
      if (!GAME.profile.achievements[key].unlocked) {
        GAME.profile.achievements[key].unlocked = true;
        const ach = GAME.profile.achievements[key];
        showFeedback(`üèÜ Achievement Unlocked: ${ach.name}!`, false);
        awardXP(50, 'achievement');
        saveProgress();
      }
    }

    function checkAchievements() {
      const stats = GAME.state.stats;
      const currentPlayer = stats[GAME.state.currentTurn];
      
      if ((stats.X.roundsWon > 0 || stats.O.roundsWon > 0) && !GAME.profile.achievements.first_win.unlocked) {
        unlockAchievement('first_win');
      }
      
      if (GAME.settings.gridSize === 4 && !GAME.profile.achievements.marathon_master.unlocked) {
        unlockAchievement('marathon_master');
      }
      
      if (GAME.profile.totalCorrect >= 50 && !GAME.profile.achievements.conditionals_guru.unlocked) {
        unlockAchievement('conditionals_guru');
      }
      
      if (GAME.profile.totalQuestions >= 100 && !GAME.profile.achievements.question_master.unlocked) {
        unlockAchievement('question_master');
      }
      
      if (currentPlayer.streak >= 10 && !GAME.profile.achievements.streak_master.unlocked) {
        unlockAchievement('streak_master');
      }
      
      if (GAME.mode === 'advanced' && (stats.X.roundsWon >= 2 || stats.O.roundsWon >= 2)) {
        unlockAchievement('triple_threat');
      }
    }

    function showAchievements() {
      document.getElementById('modeSelector').classList.add('hidden');
      document.getElementById('achievementsPanel').classList.remove('hidden');
      renderAchievements();
    }

    function closeAchievements() {
      document.getElementById('achievementsPanel').classList.add('hidden');
      document.getElementById('modeSelector').classList.remove('hidden');
    }

    function renderAchievements() {
      const grid = document.getElementById('achievementsGrid');
      grid.innerHTML = '';
      
      Object.keys(GAME.profile.achievements).forEach(key => {
        const ach = GAME.profile.achievements[key];
        const card = document.createElement('div');
        card.className = `achievement-card ${ach.unlocked ? 'unlocked' : ''}`;
        card.innerHTML = `
          <div class="achievement-icon">${ach.icon}</div>
          <div class="achievement-name">${ach.name}</div>
          <div class="achievement-desc">${ach.desc}</div>
        `;
        grid.appendChild(card);
      });
    }

    function updateGridSize(val) {
      GAME.settings.gridSize = parseInt(val);
      document.getElementById('gridSizeValue').textContent = `${val}√ó${val}`;
    }

    function updateRounds(val) {
      GAME.settings.totalRounds = parseInt(val);
      document.getElementById('roundsValue').textContent = val;
    }

    function updateQuestions(val) {
      GAME.settings.questionsPerCell = parseInt(val);
      document.getElementById('questionsValue').textContent = val;
    }

    function updateTimer(checked) {
      GAME.settings.timerEnabled = checked;
    }

    function updateSpecialCells(checked) {
      GAME.settings.specialCellsEnabled = checked;
    }

    function backToModes() {
      document.getElementById('gameSettings').classList.add('hidden');
      document.getElementById('modeSelector').classList.remove('hidden');
    }

    function startGame() {
      const size = GAME.settings.gridSize;
      GAME.state.boardState = Array(size * size).fill(null);
      GAME.state.currentRound = 1;
      GAME.state.currentTurn = 'X';
      GAME.state.cellQuestionSets = {};
      GAME.state.usedQuestionIds.clear();
      GAME.state.totalQuestionsAnswered = 0;
      GAME.state.stats = {
        X: { roundsWon: 0, cellsClaimed: 0, correctAnswers: 0, streak: 0, powerups: {hint: 2, skip: 2} },
        O: { roundsWon: 0, cellsClaimed: 0, correctAnswers: 0, streak: 0, powerups: {hint: 2, skip: 2} }
      };
      
      if (GAME.settings.specialCellsEnabled) {
        const numSpecial = Math.floor(size * size * 0.2);
        GAME.state.specialCells = [];
        while (GAME.state.specialCells.length < numSpecial) {
          const cell = Math.floor(Math.random() * size * size);
          if (!GAME.state.specialCells.includes(cell)) {
            GAME.state.specialCells.push(cell);
          }
        }
      }
      
      document.getElementById('modeSelector').classList.add('hidden');
      document.getElementById('gameSettings').classList.add('hidden');
      document.getElementById('gameArea').classList.remove('hidden');
      
      updateRoundDisplay();
      updateStats();
      updatePowerupButtons();
      renderBoard();
      updateTurnIndicator();
    }

    function renderBoard() {
      const board = document.getElementById('board');
      const size = GAME.settings.gridSize;
      
      board.className = `board size-${size}`;
      board.innerHTML = '';
      
      for (let i = 0; i < size * size; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.cell = i;
        
        if (GAME.state.specialCells.includes(i) && !GAME.state.boardState[i]) {
          cell.classList.add('special-cell');
        }
        
        if (GAME.state.boardState[i]) {
          cell.textContent = GAME.state.boardState[i] === 'X' ? '‚ùå' : '‚≠ï';
          cell.classList.add(`claimed-${GAME.state.boardState[i]}`);
        }
        
        cell.onclick = () => openCellModal(i);
        board.appendChild(cell);
      }
    }

    function getQuestionId(q) {
      return `${q.q}_${q.ans}_${q.cat || 'general'}`;
    }

    function selectFreshQuestions() {
      const difficulty = GAME.settings.difficulty;
      const needed = GAME.settings.questionsPerCell;
      const allQuestions = [];
      
      Object.keys(QUESTION_BANK).forEach(category => {
        const categoryQuestions = QUESTION_BANK[category][difficulty] || [];
        categoryQuestions.forEach(q => {
          allQuestions.push({...q, category});
        });
      });
      
      let available = allQuestions.filter(q => {
        return !GAME.state.usedQuestionIds.has(getQuestionId(q));
      });
      
      if (available.length < needed) {
        GAME.state.usedQuestionIds.clear();
        available = allQuestions;
      }
      
      const shuffled = available.sort(() => Math.random() - 0.5);
      const selected = shuffled.slice(0, needed);
      
      selected.forEach(q => {
        GAME.state.usedQuestionIds.add(getQuestionId(q));
      });
      
      return selected;
    }

    function openCellModal(cellIndex) {
      if (GAME.state.boardState[cellIndex] !== null) {
        showFeedback('‚ö†Ô∏è This cell is already claimed!', true);
        return;
      }
      
      GAME.state.activeCell = cellIndex;
      GAME.state.questionStartTime = Date.now();
      
      GAME.state.cellQuestionSets[cellIndex] = selectFreshQuestions();
      
      const questions = GAME.state.cellQuestionSets[cellIndex];
      renderQuestionModal(questions, cellIndex);
      
      if (GAME.settings.timerEnabled) {
        startTimer();
      }
    }

    function startTimer() {
      GAME.state.timeLeft = 45;
      const container = document.getElementById('timerContainer');
      const display = document.getElementById('timerDisplay');
      
      container.classList.add('show');
      display.textContent = GAME.state.timeLeft;
      display.className = 'timer-display';
      
      clearInterval(GAME.state.timer);
      GAME.state.timer = setInterval(() => {
        GAME.state.timeLeft--;
        display.textContent = GAME.state.timeLeft;
        
        if (GAME.state.timeLeft <= 15) {
          display.className = 'timer-display warning';
        }
        if (GAME.state.timeLeft <= 5) {
          display.className = 'timer-display danger';
        }
        
        if (GAME.state.timeLeft <= 0) {
          clearInterval(GAME.state.timer);
          container.classList.remove('show');
          showFeedback('‚è∞ Time\'s up!', true);
          closeModal();
          switchTurn();
        }
      }, 1000);
    }

    function stopTimer() {
      clearInterval(GAME.state.timer);
      document.getElementById('timerContainer').classList.remove('show');
    }

    function renderQuestionModal(questions, cellIndex) {
      const overlay = document.getElementById('modalOverlay');
      const content = document.getElementById('modalContent');
      
      const isSpecial = GAME.state.specialCells.includes(cellIndex);
      
      let html = `
        <div class="modal-header">
          <div class="modal-title">Cell ${cellIndex + 1} - ${GAME.state.currentTurn}'s Turn ${isSpecial ? '‚≠ê BONUS' : ''}</div>
        </div>
        <div class="question-counter">Answer ${GAME.settings.questionsPerCell} questions correctly!</div>
      `;
      
      questions.forEach((q, idx) => {
        html += `
          <div class="question-card" data-q-index="${idx}">
            <div class="question-category">${q.cat || 'Conditionals'}</div>
            <div class="question-text">${idx + 1}. ${q.q}</div>
            <div class="options-grid" id="options-${idx}">
              ${q.opts.map((opt, optIdx) => `
                <button 
                  class="option-btn" 
                  onclick="selectAnswer(${idx}, ${optIdx})"
                  id="opt-${idx}-${optIdx}"
                >
                  ${opt}
                </button>
              `).join('')}
            </div>
            <div class="feedback" id="feedback-${idx}"></div>
          </div>
        `;
      });
      
      html += `
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="submitAnswers()">Submit All</button>
        </div>
      `;
      
      content.innerHTML = html;
      overlay.classList.add('show');
    }

    function selectAnswer(qIndex, optIndex) {
      GAME.selectedAnswers[qIndex] = optIndex;
      
      const card = document.querySelector(`[data-q-index="${qIndex}"]`);
      const buttons = card.querySelectorAll('.option-btn');
      
      buttons.forEach((btn, idx) => {
        btn.classList.remove('selected');
        if (idx === optIndex) {
          btn.classList.add('selected');
        }
      });
    }

    function usePowerup(type) {
      const currentPlayer = GAME.state.stats[GAME.state.currentTurn];
      
      if (type === 'hint') {
        if (currentPlayer.powerups.hint <= 0) {
          showFeedback('‚ùå No Hint power-ups left!', true);
          return;
        }
        
        currentPlayer.powerups.hint--;
        GAME.state.activePowerup = 'hint';
        
        const questions = GAME.state.cellQuestionSets[GAME.state.activeCell];
        questions.forEach((q, idx) => {
          const correctAns = q.ans;
          const wrongIndices = q.opts.map((_, i) => i).filter(i => i !== correctAns);
          const toRemove = wrongIndices.sort(() => Math.random() - 0.5).slice(0, 2);
          
          toRemove.forEach(optIdx => {
            const btn = document.getElementById(`opt-${idx}-${optIdx}`);
            if (btn) {
              btn.disabled = true;
              btn.style.opacity = '0.3';
            }
          });
        });
        
        showFeedback('üí° Hint activated! 2 wrong answers removed!', false);
        updatePowerupButtons();
      }
      
      if (type === 'skip') {
        if (currentPlayer.powerups.skip <= 0) {
          showFeedback('‚ùå No Skip power-ups left!', true);
          return;
        }
        
        currentPlayer.powerups.skip--;
        showFeedback('‚è≠Ô∏è Question skipped!', false);
        closeModal();
        updatePowerupButtons();
      }
    }

    function updatePowerupButtons() {
      const currentPlayer = GAME.state.stats[GAME.state.currentTurn];
      
      const btnHint = document.getElementById('btnHint');
      const btnSkip = document.getElementById('btnSkip');
      
      btnHint.textContent = `üí° Hint (${currentPlayer.powerups.hint})`;
      btnHint.disabled = currentPlayer.powerups.hint <= 0;
      
      btnSkip.textContent = `‚è≠Ô∏è Skip (${currentPlayer.powerups.skip})`;
      btnSkip.disabled = currentPlayer.powerups.skip <= 0;
      
      const powerupDisplay = document.getElementById(`powerups${GAME.state.currentTurn}`);
      powerupDisplay.innerHTML = `
        <div class="powerup-item ${currentPlayer.powerups.hint > 0 ? 'active' : ''}">
          üí° √ó${currentPlayer.powerups.hint}
        </div>
        <div class="powerup-item ${currentPlayer.powerups.skip > 0 ? 'active' : ''}">
          ‚è≠Ô∏è √ó${currentPlayer.powerups.skip}
        </div>
      `;
    }

    function submitAnswers() {
      const totalQuestions = GAME.settings.questionsPerCell;
      const answeredCount = Object.keys(GAME.selectedAnswers).length;
      
      if (answeredCount < totalQuestions) {
        showFeedback(`‚ö†Ô∏è Please answer all ${totalQuestions} questions! (${answeredCount}/${totalQuestions} answered)`, true);
        return;
      }
      
      stopTimer();
      
      const cellIndex = GAME.state.activeCell;
      const questions = GAME.state.cellQuestionSets[cellIndex];
      const isSpecial = GAME.state.specialCells.includes(cellIndex);
      
      let correctCount = 0;
      let allCorrect = true;
      
      questions.forEach((q, idx) => {
        const selected = GAME.selectedAnswers[idx];
        const correct = q.ans;
        const feedback = document.getElementById(`feedback-${idx}`);
        const card = document.querySelector(`[data-q-index="${idx}"]`);
        const buttons = card.querySelectorAll('.option-btn');
        
        buttons.forEach(btn => btn.disabled = true);
        
        GAME.state.totalQuestionsAnswered++;
        GAME.profile.totalQuestions++;
        
        if (selected === correct) {
          correctCount++;
          feedback.innerHTML = `‚úÖ Correct! ${q.exp ? `<div class="explanation">${q.exp}</div>` : ''}`;
          feedback.className = 'feedback correct';
          buttons[selected].classList.add('correct');
          
          GAME.state.stats[GAME.state.currentTurn].streak++;
          GAME.profile.totalCorrect++;
        } else {
          allCorrect = false;
          feedback.innerHTML = `‚ùå Wrong! Correct answer: ${q.opts[correct]}${q.exp ? `<div class="explanation">${q.exp}</div>` : ''}`;
          feedback.className = 'feedback wrong';
          
          if (selected !== undefined) {
            buttons[selected].classList.add('wrong');
          }
          
          buttons[correct].classList.add('correct');
          
          GAME.state.stats[GAME.state.currentTurn].streak = 0;
        }
      });
      
      const timeBonus = GAME.settings.timerEnabled ? Math.max(0, GAME.state.timeLeft) : 0;
      const baseXP = correctCount * 10;
      const bonusXP = isSpecial ? baseXP : 0;
      const totalXP = baseXP + timeBonus + bonusXP;
      
      awardXP(totalXP, 'questions');
      
      GAME.state.stats[GAME.state.currentTurn].correctAnswers += correctCount;
      
      if (allCorrect && questions.length >= 5) {
        unlockAchievement('perfectionist');
      }
      
      const timeElapsed = (Date.now() - GAME.state.questionStartTime) / 1000;
      if (timeElapsed < 60 && questions.length >= 5 && allCorrect) {
        unlockAchievement('speed_demon');
      }
      
      checkAchievements();
      
      // Replace modal footer with Return button
      const modalFooter = document.querySelector('.modal-footer');
      modalFooter.innerHTML = `
        <button class="btn btn-secondary" onclick="closeModalAndReturn()">‚Üê Return</button>
      `;
      
      if (correctCount === GAME.settings.questionsPerCell) {
        setTimeout(() => {
          claimCell(cellIndex, isSpecial);
          closeModal();
          checkRoundEnd();
        }, 5000); // Give 5 seconds to review
      } else {
        setTimeout(() => {
          showFeedback(`${correctCount}/${GAME.settings.questionsPerCell} correct! Cell not claimed.`, true);
          switchTurn();
          closeModal();
        }, 5000); // Give 5 seconds to review
      }
      
      updateStats();
      updatePowerupButtons();
    }

    function closeModalAndReturn() {
      stopTimer();
      document.getElementById('modalOverlay').classList.remove('show');
      GAME.state.activeCell = null;
      GAME.state.activePowerup = null;
      Object.keys(GAME.selectedAnswers).forEach(k => delete GAME.selectedAnswers[k]);
    }

    function claimCell(cellIndex, isSpecial) {
      GAME.state.boardState[cellIndex] = GAME.state.currentTurn;
      GAME.state.stats[GAME.state.currentTurn].cellsClaimed++;
      
      if (isSpecial) {
        const currentPlayer = GAME.state.stats[GAME.state.currentTurn];
        currentPlayer.powerups.hint++;
        currentPlayer.powerups.skip++;
        showFeedback(`‚≠ê BONUS! ${GAME.state.currentTurn} gets extra power-ups!`, false);
      }
      
      renderBoard();
      updateStats();
      updatePowerupButtons();
    }

    function switchTurn() {
      GAME.state.currentTurn = GAME.state.currentTurn === 'X' ? 'O' : 'X';
      updateTurnIndicator();
      updatePowerupButtons();
    }

    function updateTurnIndicator() {
      document.getElementById('panelX').classList.toggle('active', GAME.state.currentTurn === 'X');
      document.getElementById('panelO').classList.toggle('active', GAME.state.currentTurn === 'O');
    }

    function checkRoundEnd() {
      const size = GAME.settings.gridSize;
      const board = GAME.state.boardState;
      
      const checkLine = (a, b, c) => {
        return board[a] && board[a] === board[b] && board[a] === board[c] ? board[a] : null;
      };
      
      // Check rows
      for (let i = 0; i < size; i++) {
        const start = i * size;
        if (size === 3) {
          const winner = checkLine(start, start + 1, start + 2);
          if (winner) { handleRoundWin(winner); return; }
        } else if (size === 4) {
          const winner = checkLine(start, start + 1, start + 2) || 
                         checkLine(start + 1, start + 2, start + 3);
          if (winner) { handleRoundWin(winner); return; }
        } else if (size === 5) {
          const winner = checkLine(start, start + 1, start + 2) || 
                         checkLine(start + 1, start + 2, start + 3) ||
                         checkLine(start + 2, start + 3, start + 4);
          if (winner) { handleRoundWin(winner); return; }
        }
      }
      
      // Check columns
      for (let i = 0; i < size; i++) {
        if (size === 3) {
          const winner = checkLine(i, i + size, i + size * 2);
          if (winner) { handleRoundWin(winner); return; }
        } else if (size === 4) {
          const winner = checkLine(i, i + size, i + size * 2) ||
                         checkLine(i + size, i + size * 2, i + size * 3);
          if (winner) { handleRoundWin(winner); return; }
        } else if (size === 5) {
          const winner = checkLine(i, i + size, i + size * 2) ||
                         checkLine(i + size, i + size * 2, i + size * 3) ||
                         checkLine(i + size * 2, i + size * 3, i + size * 4);
          if (winner) { handleRoundWin(winner); return; }
        }
      }
      
      // Check diagonals
      if (size === 3) {
        let winner = checkLine(0, 4, 8) || checkLine(2, 4, 6);
        if (winner) { handleRoundWin(winner); return; }
      }
      
      // Check for draw
      if (!board.includes(null)) {
        handleRoundDraw();
      }
    }

    function handleRoundWin(winner) {
      GAME.state.stats[winner].roundsWon++;
      updateStats();
      awardXP(100, 'round_win');
      
      setTimeout(() => {
        showFeedback(`üèÜ ${winner} wins Round ${GAME.state.currentRound}!`, false);
        
        if (GAME.state.currentRound < GAME.settings.totalRounds) {
          document.getElementById('nextRoundBtn').style.display = 'inline-block';
        } else {
          checkMatchWinner();
        }
      }, 1000);
    }

    function handleRoundDraw() {
      setTimeout(() => {
        showFeedback(`ü§ù Round ${GAME.state.currentRound} is a draw!`, false);
        
        if (GAME.state.currentRound < GAME.settings.totalRounds) {
          document.getElementById('nextRoundBtn').style.display = 'inline-block';
        } else {
          checkMatchWinner();
        }
      }, 1000);
    }

    function nextRound() {
      GAME.state.currentRound++;
      const size = GAME.settings.gridSize;
      GAME.state.boardState = Array(size * size).fill(null);
      GAME.state.cellQuestionSets = {};
      GAME.state.currentTurn = 'X';
      
      if (GAME.settings.specialCellsEnabled) {
        const numSpecial = Math.floor(size * size * 0.2);
        GAME.state.specialCells = [];
        while (GAME.state.specialCells.length < numSpecial) {
          const cell = Math.floor(Math.random() * size * size);
          if (!GAME.state.specialCells.includes(cell)) {
            GAME.state.specialCells.push(cell);
          }
        }
      }
      
      document.getElementById('nextRoundBtn').style.display = 'none';
      
      updateRoundDisplay();
      renderBoard();
      updateTurnIndicator();
      updatePowerupButtons();
    }

    function checkMatchWinner() {
      const xWins = GAME.state.stats.X.roundsWon;
      const oWins = GAME.state.stats.O.roundsWon;
      
      setTimeout(() => {
        if (xWins > oWins) {
          showFeedback('üéä PLAYER X WINS THE MATCH! üéä', false);
          awardXP(200, 'match_win');
        } else if (oWins > xWins) {
          showFeedback('üéä PLAYER O WINS THE MATCH! üéä', false);
          awardXP(200, 'match_win');
        } else {
          showFeedback('ü§ù MATCH ENDS IN A DRAW! ü§ù', false);
          awardXP(100, 'match_draw');
        }
        
        setTimeout(() => {
          const playAgain = confirm('Game Over! Play again?');
          if (playAgain) {
            backToMenu();
          }
        }, 3000);
      }, 2000);
    }

    function updateRoundDisplay() {
      document.getElementById('roundText').textContent = 
        `Round ${GAME.state.currentRound} of ${GAME.settings.totalRounds}`;
      
      const progress = (GAME.state.currentRound / GAME.settings.totalRounds) * 100;
      document.getElementById('roundProgressBar').style.width = `${progress}%`;
    }

    function updateStats() {
      document.getElementById('winsX').textContent = GAME.state.stats.X.roundsWon;
      document.getElementById('cellsX').textContent = GAME.state.stats.X.cellsClaimed;
      document.getElementById('correctX').textContent = GAME.state.stats.X.correctAnswers;
      
      document.getElementById('winsO').textContent = GAME.state.stats.O.roundsWon;
      document.getElementById('cellsO').textContent = GAME.state.stats.O.cellsClaimed;
      document.getElementById('correctO').textContent = GAME.state.stats.O.correctAnswers;
    }

    function forfeitGame() {
      if (confirm('Forfeit this round? The opponent wins this round.')) {
        const opponent = GAME.state.currentTurn === 'X' ? 'O' : 'X';
        GAME.state.stats[opponent].roundsWon++;
        updateStats();
        
        showFeedback(`${opponent} wins Round ${GAME.state.currentRound} by forfeit!`, true);
        
        setTimeout(() => {
          if (GAME.state.currentRound < GAME.settings.totalRounds) {
            if (confirm('Continue to next round?')) {
              nextRound();
            } else {
              backToMenu();
            }
          } else {
            checkMatchWinner();
          }
        }, 2000);
      }
    }

    function backToMenu() {
      if (!document.getElementById('gameArea').classList.contains('hidden')) {
        if (!confirm('Return to main menu? All progress will be lost.')) {
          return;
        }
      }
      resetGame();
      stopTimer();
      document.getElementById('gameArea').classList.add('hidden');
      document.getElementById('gameSettings').classList.add('hidden');
      document.getElementById('modeSelector').classList.remove('hidden');
      document.getElementById('nextRoundBtn').style.display = 'none';
    }
    
    function resetGame() {
      const size = GAME.settings.gridSize;
      GAME.state.boardState = Array(size * size).fill(null);
      GAME.state.currentRound = 1;
      GAME.state.currentTurn = 'X';
      GAME.state.cellQuestionSets = {};
      GAME.state.usedQuestionIds.clear();
      GAME.state.specialCells = [];
      GAME.state.stats = {
        X: { roundsWon: 0, cellsClaimed: 0, correctAnswers: 0, streak: 0, powerups: {hint: 2, skip: 2} },
        O: { roundsWon: 0, cellsClaimed: 0, correctAnswers: 0, streak: 0, powerups: {hint: 2, skip: 2} }
      };
      GAME.selectedAnswers = {};
    }

    function closeModal() {
      stopTimer();
      document.getElementById('modalOverlay').classList.remove('show');
      GAME.state.activeCell = null;
      GAME.state.activePowerup = null;
      Object.keys(GAME.selectedAnswers).forEach(k => delete GAME.selectedAnswers[k]);
    }

    function showFeedback(msg, isError) {
      const fb = document.getElementById('globalFeedback');
      fb.textContent = msg;
      fb.className = isError ? 'feedback-global error show' : 'feedback-global success show';
      
      setTimeout(() => {
        fb.classList.remove('show');
      }, 3000);
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    window.addEventListener('DOMContentLoaded', async () => {
      await loadQuestions(CURRENT_LEVEL);
      loadProgress();
      updateDifficultyButtons();
      console.log('‚úÖ INTUITY Conditionals Master loaded!');
    });
  </script>
</body>
</html>
